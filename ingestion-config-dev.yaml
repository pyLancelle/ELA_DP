# ELA Data Platform - DEV Environment Ingestion Configuration
# This file defines all data ingestion jobs for DEVELOPMENT environment
# DEV environment uses more frequent schedules for testing and development

# Global Configuration
global:
  timezone: "Europe/Paris"
  retry_attempts: 2
  max_parallel_jobs: 3
  gcs_bucket: "ela-dp-dev"
  timeout_minutes: 20
  environment: "dev"

# Job Groups for manual execution
job_groups:
  spotify_all:
    description: "All Spotify data sources (DEV)"
    jobs: ["spotify_recently_played", "spotify_saved_tracks", "spotify_saved_albums", "spotify_artist_enrichment", "spotify_album_enrichment"]
  
  daily_jobs:
    description: "Jobs that run daily (DEV)"
    jobs: ["spotify_saved_tracks", "garmin_sleep", "todoist_projects"]

  email_test:
    description: "Email testing jobs (DEV)"
    jobs: ["spotify_email_test", "garmin_email_test", "strava_email_test"]

  # Data Fetching Groups (Step 1)
  garmin_all:
    description: "Fetch all Garmin data (Step 1/2)"
    jobs: ["garmin_activities", "garmin_activity_details", "garmin_activity_splits", "garmin_activity_weather", "garmin_activity_hr_zones", "garmin_sleep", "garmin_steps", "garmin_heart_rate", "garmin_body_battery", "garmin_stress", "garmin_training_status", "garmin_hrv", "garmin_race_predictions", "garmin_floors", "garmin_weight", "garmin_endurance_score", "garmin_hill_score"]
  
  spotify_fetch_all:
    description: "Fetch all Spotify data (Step 1/2)"
    jobs: ["spotify_recently_played", "spotify_saved_tracks", "spotify_saved_albums", "spotify_artist_enrichment", "spotify_album_enrichment"]
  
  chess_fetch_all:
    description: "Fetch all Chess.com data (Step 1/2)"
    jobs: ["chess_player_stats", "chess_games"]
  
  # Data Ingestion Groups (Step 2)
  ingestion_only:
    description: "Run only ingestion jobs - GCS → BigQuery (Step 2/2)"
    jobs: ["garmin_ingest_auto", "spotify_ingest_auto", "chess_ingest"]

  garmin_ingest_only:
    description: "Ingest Garmin data only - GCS → BigQuery (auto-detection)"
    jobs: ["garmin_ingest_auto"]

  # Data Transformation Groups (Step 3)
  garmin_dbt_only:
    description: "Run DBT transformations for Garmin lake models only"
    jobs: ["garmin_dbt_lake_run"]
  
  spotify_dbt_only:
    description: "Run DBT transformations for Spotify lake + Hub music models"
    jobs: ["spotify_dbt_lake_run"]
  
  chess_ingest_only:
    description: "Ingest Chess.com data only - GCS → BigQuery"
    jobs: ["chess_ingest"]
  
  chess_dbt_only:
    description: "Run DBT transformations for Chess.com lake models only"
    jobs: ["chess_dbt_lake_run"]
  
  dbt_transformations:
    description: "Run all DBT transformations"
    jobs: ["garmin_dbt_lake_run", "spotify_dbt_lake_run", "chess_dbt_lake_run"]
  
  # Legacy Combined Pipelines (runs in parallel - use with caution)
  garmin_pipeline:
    description: "Complete Garmin pipeline (parallel execution - may have timing issues)"
    jobs: ["garmin_activities", "garmin_activity_details", "garmin_activity_splits", "garmin_activity_weather", "garmin_activity_hr_zones", "garmin_sleep", "garmin_steps", "garmin_heart_rate", "garmin_body_battery", "garmin_stress", "garmin_training_status", "garmin_hrv", "garmin_race_predictions", "garmin_floors", "garmin_weight", "garmin_endurance_score", "garmin_hill_score", "garmin_ingest_activities", "garmin_ingest_sleep", "garmin_ingest_floors", "garmin_ingest_weight", "garmin_dbt_lake_run"]
  
  strava_pipeline:
    description: "Complete Strava pipeline (parallel execution - may have timing issues)"
    jobs: ["strava_activities", "strava_athlete", "strava_ingest"]
  
  spotify_ingest_only:
    description: "Ingest Spotify data only - GCS → BigQuery (auto-detection)"
    jobs: ["spotify_ingest_auto"]

  spotify_pipeline:
    description: "Complete Spotify pipeline (parallel execution - may have timing issues)"
    jobs: ["spotify_recently_played", "spotify_saved_tracks", "spotify_saved_albums", "spotify_artist_enrichment", "spotify_album_enrichment", "spotify_ingest_auto", "spotify_dbt_lake_run"]
  
  chess_pipeline:
    description: "Complete Chess.com pipeline (parallel execution - may have timing issues)"
    jobs: ["chess_player_stats", "chess_games", "chess_ingest", "chess_dbt_lake_run"]

# Individual Jobs Configuration - DEV Environment
jobs:
  # =================== SPOTIFY JOBS (DEV) ===================
  spotify_recently_played:
    service: "spotify"
    data_type: "recently_played"
    description: "Fetch recently played tracks from Spotify every 3 hours (9am-midnight Paris)"
    cron: "0 8,11,14,17,20,23 * * *"  # Every 3 hours from 9am to midnight Paris time (8am-11pm UTC)
    command: "python -m src.connectors.spotify.spotify_fetch recently_played --limit 50"
    environment: "dev"
    enabled: true
    dependencies: ["SPOTIFY_CLIENT_ID", "SPOTIFY_CLIENT_SECRET", "SPOTIFY_REDIRECT_URI", "SPOTIFY_REFRESH_TOKEN"]

  spotify_saved_tracks:
    service: "spotify"
    data_type: "saved_tracks"
    description: "Fetch last 20 saved tracks from Spotify daily at midday Paris time"
    cron: "0 11,23 * * *"  # Daily at 11:00 UTC (12:00 Paris time)
    command: "python -m src.connectors.spotify.spotify_fetch saved_tracks --limit 50"
    environment: "dev"
    enabled: true
    dependencies: ["SPOTIFY_CLIENT_ID", "SPOTIFY_CLIENT_SECRET", "SPOTIFY_REDIRECT_URI", "SPOTIFY_REFRESH_TOKEN"]

  spotify_saved_albums:
    service: "spotify"
    data_type: "saved_albums"
    description: "Fetch last 10 saved albums from Spotify daily at midday Paris time"
    cron: "0 11,23 * * *"  # Daily at 11:00 UTC (12:00 Paris time)
    command: "python -m src.connectors.spotify.spotify_fetch saved_albums --limit 50"
    environment: "dev"
    enabled: true
    dependencies: ["SPOTIFY_CLIENT_ID", "SPOTIFY_CLIENT_SECRET", "SPOTIFY_REDIRECT_URI", "SPOTIFY_REFRESH_TOKEN"]

  spotify_artist_enrichment:
    service: "spotify"
    data_type: "artist_enrichment"
    description: "Fetch artist enrichment data from Spotify (weekly on Sunday at 11:00 Paris time)"
    cron: "0 10 * * 0"  # Weekly on Sundays at 10:00 UTC (11:00 Paris time)
    command: "python -m src.connectors.spotify.spotify_artist_enrichment --mode incremental --dataset dp_lake_dev --gcs-bucket ela-dp-dev"
    environment: "dev"
    enabled: true
    dependencies: ["SPOTIFY_CLIENT_ID", "SPOTIFY_CLIENT_SECRET", "SPOTIFY_REDIRECT_URI", "SPOTIFY_REFRESH_TOKEN", "GCP_PROJECT_ID", "GCP_SERVICE_ACCOUNT_KEY"]

  spotify_album_enrichment:
    service: "spotify"
    data_type: "album_enrichment"
    description: "Fetch album enrichment data from Spotify (weekly on Sunday at 11:15 Paris time)"
    cron: "15 10 * * 0"  # Weekly on Sundays at 10:15 UTC (11:15 Paris time) - 15min after artists
    command: "python -m src.connectors.spotify.spotify_album_enrichment --mode incremental --dataset dp_lake_dev --gcs-bucket ela-dp-dev"
    environment: "dev"
    enabled: true
    dependencies: ["SPOTIFY_CLIENT_ID", "SPOTIFY_CLIENT_SECRET", "SPOTIFY_REDIRECT_URI", "SPOTIFY_REFRESH_TOKEN", "GCP_PROJECT_ID", "GCP_SERVICE_ACCOUNT_KEY"]

  # =================== GARMIN JOBS (DEV) ===================
  # =================== GARMIN PIPELINE STEPS ===================
  garmin_fetch:
    service: "garmin"
    data_type: "fetch"
    description: "Fetch Garmin data (Step 1/4)"
    cron: ""  # Triggered by pipeline
    command: "python -m src.connectors.garmin --days 3"
    environment: "dev"
    enabled: true
    dependencies: ["GARMIN_USERNAME", "GARMIN_PASSWORD"]

  move_to_gcs:
    service: "utils"
    data_type: "upload"
    description: "Move local JSONL files to GCS (Step 2/4)"
    cron: ""  # Triggered by pipeline
    command: "python -m src.utils.gcs_upload --bucket ela-dp-dev --destination garmin/landing/"
    environment: "dev"
    enabled: true
    dependencies: ["GCP_SERVICE_ACCOUNT_KEY"]

  garmin_ingest:
    service: "garmin"
    data_type: "ingest"
    description: "Ingest Garmin data from GCS to BigQuery (Step 3/4)"
    cron: ""  # Triggered by pipeline
    command: "python -m src.connectors.garmin.garmin_ingest --env dev"
    environment: "dev"
    enabled: true
    dependencies: ["GCP_SERVICE_ACCOUNT_KEY", "GCP_PROJECT_ID"]

  garmin_pipeline_daily:
    service: "garmin"
    data_type: "pipeline"
    description: "Run complete Garmin pipeline sequentially"
    cron: "0 11 * * *"  # Daily at 11:00 UTC
    steps:
      - "garmin_fetch"
      - "move_to_gcs"
      - "garmin_ingest"
      - "garmin_dbt_lake_run"
    command: "python -m src.orchestrator --pipeline garmin_pipeline_daily --env dev"
    environment: "dev"
    enabled: true
    dependencies: ["GARMIN_USERNAME", "GARMIN_PASSWORD", "GCP_SERVICE_ACCOUNT_KEY", "GCP_PROJECT_ID"]

  # =================== WITHINGS JOBS (DEV) ===================
  withings_sync:
    service: "withings"
    data_type: "sync"
    description: "Sync Withings body composition to Garmin (DEV - daily before weight fetch)"
    cron: "55 10 * * *"  # Daily at 10:55 UTC (11:55 Paris time) - 5min before garmin_weight
    command: "python -m src.connectors.withings --days 7 --user-height 1.72 --dedupe-hours 24"
    environment: "dev"
    enabled: true
    dependencies: ["GARMIN_USERNAME", "GARMIN_PASSWORD", "WITHINGS_CLIENT_ID", "WITHINGS_CLIENT_SECRET", "WITHINGS_CREDENTIALS_JSON"]

  # Special backfill job for 1 year of data
  garmin_backfill_1year:
    service: "garmin"
    data_type: "all"
    description: "Backfill 1 year of Garmin data (manual trigger only)"
    cron: ""  # No automatic schedule - manual only
    command: "python -m src.connectors.garmin.garmin --days 10"
    environment: "dev"
    enabled: false  # Manual trigger only
    dependencies: ["GARMIN_USERNAME", "GARMIN_PASSWORD"]

  # =================== CHESS.COM JOBS (DEV) ===================
  chess_player_stats:
    service: "chess"
    data_type: "player_stats"
    description: "Fetch player statistics from Chess.com (DEV - daily at 10pm Paris)"
    cron: "0 21 * * *"  # Daily at 21:00 UTC (22:00 Paris time)
    command: "python -m src.connectors.chess.chess_fetch TTTiennou --data-types player_stats"
    environment: "dev"
    enabled: true
    dependencies: []

  chess_games:
    service: "chess"
    data_type: "games"
    description: "Fetch recent games from Chess.com (DEV - daily at 10pm Paris)"
    cron: "0 21 * * *"  # Daily at 21:00 UTC (22:00 Paris time)
    command: "python -m src.connectors.chess.chess_fetch TTTiennou --data-types games --days 2"
    environment: "dev"
    enabled: true
    dependencies: []


  # =================== INGESTION JOBS (DEV) ===================
  # Auto-ingestion: single job that detects and processes all data types
  garmin_ingest_auto:
    service: "garmin"
    data_type: "auto"
    description: "Auto-ingest all Garmin data types (smart detection from filenames)"
    cron: "30 */2 * * *"  # 30 minutes after data fetch
    command: "python -m src.connectors.garmin.garmin_ingest_auto --env dev"
    environment: "dev"
    enabled: true
    dependencies: ["GCP_SERVICE_ACCOUNT_KEY", "GCP_PROJECT_ID"]

  garmin_dbt_lake_run:
    service: "garmin"
    data_type: "dbt_lake"
    description: "Run DBT transformations for Garmin lake models (30min after ingestion)"
    cron: "0 */2 * * *"  # Every 2 hours at :00 (30min after ingestion at :30)
    command: "python -m src.services.dbt.dbt_run --env dev --select tag:garmin"
    environment: "dev"
    enabled: true
    dependencies: ["GCP_SERVICE_ACCOUNT_KEY", "GCP_PROJECT_ID"]

  # Auto-ingestion: single job that detects and processes all data types
  spotify_ingest_auto:
    service: "spotify"
    data_type: "auto"
    description: "Auto-ingest all Spotify data types (smart detection from filenames)"
    cron: "30 * * * *"  # 30 minutes after hourly fetch
    command: "python -m src.connectors.spotify.spotify_ingest_auto --env dev"
    environment: "dev"
    enabled: true
    dependencies: ["GCP_SERVICE_ACCOUNT_KEY", "GCP_PROJECT_ID"]

  spotify_dbt_lake_run:
    service: "spotify"
    data_type: "dbt_lake_hub"
    description: "Run DBT transformations for Spotify lake + Hub music (30min after ingestion)"
    cron: "0 * * * *"  # Every hour at :00 (30min after ingestion at :30)
    command: "python -m src.services.dbt.dbt_run --env dev --select tag:spotify tag:music"
    environment: "dev"
    enabled: true
    dependencies: ["GCP_SERVICE_ACCOUNT_KEY", "GCP_PROJECT_ID"]

  chess_ingest:
    service: "chess"
    data_type: "ingest"
    description: "Ingest Chess.com data from GCS to BigQuery (DEV - daily at 11pm Paris)"
    cron: "0 22 * * *"  # Daily at 22:00 UTC (23:00 Paris time) - 1h after fetch
    command: "python -m src.connectors.chess.chess_ingest --env dev"
    environment: "dev"
    enabled: true
    dependencies: ["GCP_SERVICE_ACCOUNT_KEY", "GCP_PROJECT_ID"]

  chess_dbt_lake_run:
    service: "chess"
    data_type: "dbt_lake"
    description: "Run DBT transformations for Chess.com lake models (DEV)"
    cron: "0 7,12,16,20,23 * * *"  # 5 times per day at specific hours: 7h, 12h, 16h, 20h, 23h UTC
    command: "python -m src.connectors.chess.chess_dbt_run --env dev"
    environment: "dev"
    enabled: false
    dependencies: ["GCP_SERVICE_ACCOUNT_KEY", "GCP_PROJECT_ID"]

# Service-specific configuration
services:
  spotify:
    base_path: "src/connectors/spotify"
    fetch_script: "spotify_fetch.py"
    default_limit: 20  # Smaller limits for DEV
    supported_data_types: ["recently_played", "saved_tracks", "saved_albums", "playlists", "top_tracks", "top_artists", "artist_enrichment", "album_enrichment"]
  
  strava:
    base_path: "src/connectors/strava"
    fetch_script: "strava.py"
    supported_data_types: ["activities", "athlete"]
  
  garmin:
    base_path: "src/connectors/garmin"
    fetch_script: "__main__.py"  # Now a module with __main__.py entry point
    supported_data_types: ["activities", "activity_details", "activity_splits", "activity_weather", "activity_hr_zones", "activity_exercise_sets", "sleep", "steps", "heart_rate", "body_battery", "stress", "user_summary", "stats_and_body", "training_readiness", "rhr_daily", "spo2", "respiration", "intensity_minutes", "max_metrics", "all_day_events", "device_info", "training_status", "hrv", "race_predictions", "floors", "weight", "body_composition", "endurance_score", "hill_score"]
  
  todoist:
    base_path: "src/connectors/todoist"
    fetch_script: "todoist.py"
    supported_data_types: ["tasks", "projects"]
  
  chess:
    base_path: "src/connectors/chess"
    fetch_script: "chess_fetch.py"
    supported_data_types: ["player_stats", "games"]

  mail:
    base_path: "src/services/mail"
    main_script: "main.py"
    supported_data_types: ["spotify_email"]
