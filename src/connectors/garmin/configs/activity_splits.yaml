# =============================================================================
# GARMIN ACTIVITY SPLITS - COMPLETE INGESTION CONFIGURATION
# =============================================================================
# This configuration handles Garmin activity splits data with 3 structures:
#
# 1. splits.lapDTOs: Detailed lap data (auto/manual laps, 1km/1mi splits)
# 2. split_summaries.splitSummaries: Aggregated split summaries by type
# 3. typed_splits.splits: Typed splits (kilometer, mile, etc.)
#
# Note: Due to complexity, lapDTOs and typed splits stored in raw_data.
# split_summaries extracted as REPEATED RECORD for easy querying.
# =============================================================================

data_type: activity_splits
description: "Garmin activity splits with lap and segment data"
version: "1.0.0"
owner: "data-platform"
last_updated: "2025-11-01"

# =============================================================================
# SOURCE CONFIGURATION
# =============================================================================
source:
  bucket_pattern: "ela-dp-{env}"
  landing_path: "garmin/landing"
  file_pattern: "*_activity_splits.jsonl"
  archive_path: "garmin/archive"
  rejected_path: "garmin/rejected"
  delete_after_archive: false
  max_file_age_days: 30

# =============================================================================
# DESTINATION CONFIGURATION
# =============================================================================
destination:
  project_id: "${GCP_PROJECT_ID}"
  dataset_pattern: "dp_lake_{env}"
  table_name: "lake_garmin__normalized_activity_splits"
  write_disposition: "WRITE_APPEND"
  create_disposition: "CREATE_IF_NEEDED"

  partition:
    enabled: true
    field: "dp_inserted_at"
    type: "DAY"
    expiration_days: null

  clustering:
    enabled: true
    fields:
      - "activityId"
      - "startTimeLocal"

# =============================================================================
# PARSING CONFIGURATION
# =============================================================================
parsing:
  strategy: "hybrid"

  core_fields:
    # =========================================================================
    # ACTIVITY IDENTIFICATION
    # =========================================================================
    - name: activityId
      json_path: "$.activityId"
      bq_type: INT64
      mode: REQUIRED
      description: "Garmin activity ID (foreign key to activities table)"
      validations:
        - type: not_null
        - type: positive

    - name: activityName
      json_path: "$.activityName"
      bq_type: STRING
      mode: NULLABLE
      description: "Activity name (user-defined)"

    - name: startTimeLocal
      json_path: "$.startTimeLocal"
      bq_type: TIMESTAMP
      mode: REQUIRED
      description: "Activity start time in local timezone (used for partitioning)"
      transform: "string_to_timestamp_space"
      validations:
        - type: not_null

    - name: data_type
      json_path: "$.data_type"
      bq_type: STRING
      mode: NULLABLE
      description: "Data type identifier (always 'activity_splits')"

    # =========================================================================
    # ACTIVITY TYPE (RECORD)
    # =========================================================================
    - name: activityType
      bq_type: RECORD
      mode: NULLABLE
      json_path: "$.activityType"
      description: "Activity type details"
      fields:
        - name: typeId
          json_path: "$.typeId"
          bq_type: INT64
          mode: NULLABLE
          description: "Activity type ID (1=running, 2=cycling, etc.)"

        - name: typeKey
          json_path: "$.typeKey"
          bq_type: STRING
          mode: NULLABLE
          description: "Activity type key (running, cycling, swimming, etc.)"

        - name: parentTypeId
          json_path: "$.parentTypeId"
          bq_type: INT64
          mode: NULLABLE
          description: "Parent activity type ID"

        - name: isHidden
          json_path: "$.isHidden"
          bq_type: BOOL
          mode: NULLABLE
          description: "Whether activity type is hidden"

        - name: restricted
          json_path: "$.restricted"
          bq_type: BOOL
          mode: NULLABLE
          description: "Whether activity type is restricted"

        - name: trimmable
          json_path: "$.trimmable"
          bq_type: BOOL
          mode: NULLABLE
          description: "Whether activity can be trimmed"

    # =========================================================================
    # SPLIT SUMMARIES (REPEATED RECORD)
    # =========================================================================
    - name: splitSummaries
      bq_type: RECORD
      mode: REPEATED
      json_path: "$.split_summaries.splitSummaries"
      description: "Aggregated split summaries by split type"
      fields:
        - name: splitType
          json_path: "$.splitType"
          bq_type: STRING
          mode: NULLABLE
          description: "Split type (KILOMETER_SPLIT, MILE_SPLIT, etc.)"

        - name: noOfSplits
          json_path: "$.noOfSplits"
          bq_type: INT64
          mode: NULLABLE
          description: "Number of splits of this type"

        - name: distance
          json_path: "$.distance"
          bq_type: FLOAT64
          mode: NULLABLE
          description: "Total distance for this split type (meters)"

        - name: maxDistance
          json_path: "$.maxDistance"
          bq_type: FLOAT64
          mode: NULLABLE
          description: "Maximum split distance (meters)"

        - name: maxDistanceWithPrecision
          json_path: "$.maxDistanceWithPrecision"
          bq_type: FLOAT64
          mode: NULLABLE
          description: "Maximum split distance with precision (meters)"

        - name: duration
          json_path: "$.duration"
          bq_type: FLOAT64
          mode: NULLABLE
          description: "Total duration (seconds)"

        - name: movingDuration
          json_path: "$.movingDuration"
          bq_type: FLOAT64
          mode: NULLABLE
          description: "Moving duration (seconds)"

        - name: elevationGain
          json_path: "$.elevationGain"
          bq_type: FLOAT64
          mode: NULLABLE
          description: "Total elevation gain (meters)"

        - name: elevationLoss
          json_path: "$.elevationLoss"
          bq_type: FLOAT64
          mode: NULLABLE
          description: "Total elevation loss (meters)"

        - name: averageElevationGain
          json_path: "$.averageElevationGain"
          bq_type: FLOAT64
          mode: NULLABLE
          description: "Average elevation gain per split (meters)"

        - name: maxElevationGain
          json_path: "$.maxElevationGain"
          bq_type: FLOAT64
          mode: NULLABLE
          description: "Maximum elevation gain in a split (meters)"

        - name: calories
          json_path: "$.calories"
          bq_type: FLOAT64
          mode: NULLABLE
          description: "Total calories burned"

        - name: bmrCalories
          json_path: "$.bmrCalories"
          bq_type: FLOAT64
          mode: NULLABLE
          description: "Basal metabolic rate calories"

        - name: averageSpeed
          json_path: "$.averageSpeed"
          bq_type: FLOAT64
          mode: NULLABLE
          description: "Average speed (m/s)"

        - name: averageMovingSpeed
          json_path: "$.averageMovingSpeed"
          bq_type: FLOAT64
          mode: NULLABLE
          description: "Average moving speed (m/s)"

        - name: maxSpeed
          json_path: "$.maxSpeed"
          bq_type: FLOAT64
          mode: NULLABLE
          description: "Maximum speed (m/s)"

        - name: avgGradeAdjustedSpeed
          json_path: "$.avgGradeAdjustedSpeed"
          bq_type: FLOAT64
          mode: NULLABLE
          description: "Average grade-adjusted speed (m/s)"

        - name: avgVerticalSpeed
          json_path: "$.avgVerticalSpeed"
          bq_type: FLOAT64
          mode: NULLABLE
          description: "Average vertical speed (m/s)"

        - name: averageHR
          json_path: "$.averageHR"
          bq_type: FLOAT64
          mode: NULLABLE
          description: "Average heart rate (bpm)"

        - name: maxHR
          json_path: "$.maxHR"
          bq_type: INT64
          mode: NULLABLE
          description: "Maximum heart rate (bpm)"

        - name: averageRunCadence
          json_path: "$.averageRunCadence"
          bq_type: FLOAT64
          mode: NULLABLE
          description: "Average run cadence (spm)"

        - name: maxRunCadence
          json_path: "$.maxRunCadence"
          bq_type: INT64
          mode: NULLABLE
          description: "Maximum run cadence (spm)"

        - name: avgStepFrequency
          json_path: "$.avgStepFrequency"
          bq_type: FLOAT64
          mode: NULLABLE
          description: "Average step frequency (Hz)"

        - name: avgStepLength
          json_path: "$.avgStepLength"
          bq_type: FLOAT64
          mode: NULLABLE
          description: "Average step length (cm)"

        - name: groundContactTime
          json_path: "$.groundContactTime"
          bq_type: FLOAT64
          mode: NULLABLE
          description: "Average ground contact time (ms)"

        - name: strideLength
          json_path: "$.strideLength"
          bq_type: FLOAT64
          mode: NULLABLE
          description: "Average stride length (cm)"

        - name: verticalOscillation
          json_path: "$.verticalOscillation"
          bq_type: FLOAT64
          mode: NULLABLE
          description: "Average vertical oscillation (cm)"

        - name: verticalRatio
          json_path: "$.verticalRatio"
          bq_type: FLOAT64
          mode: NULLABLE
          description: "Average vertical ratio (%)"

        - name: averagePower
          json_path: "$.averagePower"
          bq_type: FLOAT64
          mode: NULLABLE
          description: "Average power (watts)"

        - name: maxPower
          json_path: "$.maxPower"
          bq_type: INT64
          mode: NULLABLE
          description: "Maximum power (watts)"

        - name: normalizedPower
          json_path: "$.normalizedPower"
          bq_type: FLOAT64
          mode: NULLABLE
          description: "Normalized power (watts)"

        - name: averageTemperature
          json_path: "$.averageTemperature"
          bq_type: FLOAT64
          mode: NULLABLE
          description: "Average temperature (Celsius)"

        - name: maxTemperature
          json_path: "$.maxTemperature"
          bq_type: INT64
          mode: NULLABLE
          description: "Maximum temperature (Celsius)"

        - name: minTemperature
          json_path: "$.minTemperature"
          bq_type: INT64
          mode: NULLABLE
          description: "Minimum temperature (Celsius)"

        - name: totalExerciseReps
          json_path: "$.totalExerciseReps"
          bq_type: INT64
          mode: NULLABLE
          description: "Total exercise repetitions"

  # ===========================================================================
  # EXTENDED FIELDS
  # ===========================================================================
  extended_fields_reference:
    note: "Detailed lap and typed splits data stored in raw_data JSON"
    reason: "150 paths with complex nested arrays - too large for static schema"
    structures:
      - "splits.lapDTOs: Individual lap details (40+ fields per lap)"
      - "typed_splits.splits: Typed splits with coordinates (40+ fields per split)"
      - "splits.eventDTOs: Event markers"
    query_access: "Use JSON_EXTRACT functions to access detailed split data"

# =============================================================================
# METADATA FIELDS
# =============================================================================
metadata_fields:
  - name: raw_data
    bq_type: JSON
    mode: NULLABLE
    description: "Complete activity splits JSON including lapDTOs and typed_splits"

  - name: dp_inserted_at
    bq_type: TIMESTAMP
    mode: REQUIRED
    description: "Timestamp when record was ingested"
    default: "CURRENT_TIMESTAMP"

  - name: source_file
    bq_type: STRING
    mode: NULLABLE
    description: "Source JSONL filename"

# =============================================================================
# QUALITY CHECKS
# =============================================================================
quality_checks:
  unique_key: activityId
  deduplication_strategy: "keep_latest"

  required_fields:
    - activityId
    - startTimeLocal

  validation_mode: "warn"

  null_handling:
    strategy: "allow"
    replacement_values: {}

# =============================================================================
# TRANSFORMATIONS
# =============================================================================
transformations:
  string_to_timestamp_space:
    description: "Convert 'YYYY-MM-DD HH:MM:SS' string to TIMESTAMP"
    logic: "datetime.strptime(value, '%Y-%m-%d %H:%M:%S')"

# =============================================================================
# PERFORMANCE CONFIGURATION
# =============================================================================
performance:
  batch_size: 500
  max_batch_size_mb: 10
  max_workers: 4
  parallel_file_limit: 10
  max_memory_mb: 2048
  stream_large_files: true
  bq_job_timeout_seconds: 600
  gcs_download_timeout: 300

  retry:
    enabled: true
    max_attempts: 3
    backoff_seconds: 5
    backoff_multiplier: 2

# =============================================================================
# LOGGING
# =============================================================================
logging:
  level: INFO
  console: true
  file: false
  include_sample_records: true
  max_sample_records: 3
  log_rejected_records: true
  log_validation_failures: true
  track_metrics: true

# =============================================================================
# ALERTING
# =============================================================================
alerting:
  enabled: false

  conditions:
    - name: high_rejection_rate
      threshold: 0.1

    - name: no_data
      threshold: 0

    - name: processing_time
      threshold: 600

  channels:
    - email
    - slack

# =============================================================================
# EXAMPLES
# =============================================================================
examples:
  - name: "Ingest activity_splits to dev"
    command: "python -m src.connectors.garmin.garmin_ingest_v2 --config activity_splits --env dev"

  - name: "Ingest activity_splits to prod"
    command: "python -m src.connectors.garmin.garmin_ingest_v2 --config activity_splits --env prd"

  - name: "Dry run"
    command: "python -m src.connectors.garmin.garmin_ingest_v2 --config activity_splits --env dev --dry-run"

# =============================================================================
# NOTES
# =============================================================================
notes: |
  GARMIN ACTIVITY SPLITS:

  Splits represent segments of an activity (laps, kilometers, miles).
  This dataset contains 3 split structures (150 JSON paths total):

  1. **split_summaries.splitSummaries**: Aggregated data by split type
     - Extracted as REPEATED RECORD for easy querying
     - Contains: KILOMETER_SPLIT, MILE_SPLIT, etc.
     - Includes averages and totals per split type

  2. **splits.lapDTOs**: Detailed lap data (stored in raw_data)
     - Auto laps (every 1km/1mi)
     - Manual laps (user-triggered)
     - 40+ metrics per lap (HR, pace, power, cadence, GPS coordinates)

  3. **typed_splits.splits**: Typed splits (stored in raw_data)
     - Similar to lapDTOs but with type field
     - GPS coordinates per split
     - 40+ metrics per split

  Split types:
  - KILOMETER_SPLIT: Every 1000m
  - MILE_SPLIT: Every 1609m (1 mile)
  - AUTO_LAP: Automatic distance-based
  - MANUAL_LAP: User-triggered
  - INTERVAL: Workout intervals

  Query examples:

  # Split summaries by activity
  SELECT
    activityId,
    activityName,
    startTimeLocal,
    split.splitType,
    split.noOfSplits,
    ROUND(split.distance / 1000, 2) AS distance_km,
    ROUND(split.duration / 60, 1) AS duration_min,
    ROUND(split.averageSpeed * 3.6, 2) AS avg_speed_kmh,
    ROUND(1000 / (split.averageSpeed * 60), 2) AS avg_pace_min_per_km,
    ROUND(split.averageHR, 1) AS avg_hr,
    ROUND(split.averageRunCadence, 1) AS avg_cadence
  FROM `lake_garmin__activity_splits_normalized`,
  UNNEST(splitSummaries) AS split
  WHERE startTimeLocal >= '2025-10-01'
  ORDER BY activityId, split.splitType;

  # Kilometer splits summary
  SELECT
    activityId,
    activityName,
    split.noOfSplits AS num_kilometers,
    ROUND(split.distance / 1000, 2) AS total_km,
    ROUND(split.duration / 60, 1) AS total_minutes,
    ROUND(split.averageSpeed * 3.6, 2) AS avg_speed_kmh,
    ROUND(1000 / (split.averageSpeed * 60), 2) AS avg_pace_min_per_km,
    ROUND(split.averageHR, 1) AS avg_hr
  FROM `lake_garmin__activity_splits_normalized`,
  UNNEST(splitSummaries) AS split
  WHERE split.splitType = 'KILOMETER_SPLIT'
    AND startTimeLocal >= '2025-10-01'
  ORDER BY startTimeLocal DESC;

  # Extract individual laps from raw_data
  SELECT
    activityId,
    lap.lapIndex,
    lap.distance,
    lap.duration,
    lap.averageSpeed,
    lap.averageHR,
    lap.averageRunCadence
  FROM `lake_garmin__activity_splits_normalized`,
  UNNEST(JSON_EXTRACT_ARRAY(raw_data, '$.splits.lapDTOs')) AS lap_json,
  UNNEST([STRUCT(
    CAST(JSON_EXTRACT_SCALAR(lap_json, '$.lapIndex') AS INT64) AS lapIndex,
    CAST(JSON_EXTRACT_SCALAR(lap_json, '$.distance') AS FLOAT64) AS distance,
    CAST(JSON_EXTRACT_SCALAR(lap_json, '$.duration') AS FLOAT64) AS duration,
    CAST(JSON_EXTRACT_SCALAR(lap_json, '$.averageSpeed') AS FLOAT64) AS averageSpeed,
    CAST(JSON_EXTRACT_SCALAR(lap_json, '$.averageHR') AS FLOAT64) AS averageHR,
    CAST(JSON_EXTRACT_SCALAR(lap_json, '$.averageRunCadence') AS FLOAT64) AS averageRunCadence
  )]) AS lap
  WHERE activityId = 20802419671
  ORDER BY lap.lapIndex;

  # Compare split types for same activity
  SELECT
    activityId,
    activityName,
    split.splitType,
    split.noOfSplits,
    ROUND(split.averageSpeed * 3.6, 2) AS avg_speed_kmh,
    ROUND(split.averageHR, 1) AS avg_hr
  FROM `lake_garmin__activity_splits_normalized`,
  UNNEST(splitSummaries) AS split
  WHERE activityId = 20802419671
  ORDER BY split.splitType;

  Speed conversions:
  - m/s to km/h: multiply by 3.6
  - m/s to min/km (pace): 1000 / (m/s * 60)
  - m/s to mph: multiply by 2.237
