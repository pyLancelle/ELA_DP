# =============================================================================
# GARMIN ENDURANCE SCORE - COMPLETE INGESTION CONFIGURATION
# =============================================================================
# This configuration handles Garmin endurance score data with weekly history.
#
# Structure:
# - Top-level: userProfilePK, startDate, endDate, avg, max
# - enduranceScoreDTO: Current score, classification, limits, contributors
# - groupMap: Weekly historical scores (stored in raw_data as dynamic keys)
#
# Note: groupMap has dynamic date keys (2025-10-13, 2025-10-20, etc.) which
# cannot be mapped to static RECORD fields. It is stored in raw_data JSON.
# =============================================================================

data_type: endurance_score
description: "Garmin endurance score with training contributions and weekly history"
version: "1.0.0"
owner: "data-platform"
last_updated: "2025-11-01"

# =============================================================================
# SOURCE CONFIGURATION
# =============================================================================
source:
  bucket_pattern: "ela-dp-{env}"
  landing_path: "garmin/landing"
  file_pattern: "*_endurance_score.jsonl"
  archive_path: "garmin/archive"
  rejected_path: "garmin/rejected"
  delete_after_archive: false
  max_file_age_days: 30

# =============================================================================
# DESTINATION CONFIGURATION
# =============================================================================
destination:
  project_id: "${GCP_PROJECT_ID}"
  dataset_pattern: "dp_lake_{env}"
  table_name: "lake_garmin__normalized_endurance_score"
  write_disposition: "WRITE_APPEND"
  create_disposition: "CREATE_IF_NEEDED"

  partition:
    enabled: true
    field: "dp_inserted_at"
    type: "DAY"
    expiration_days: null

  clustering:
    enabled: true
    fields:
      - "userProfilePK"
      - "startDate"

# =============================================================================
# PARSING CONFIGURATION
# =============================================================================
parsing:
  strategy: "hybrid"

  core_fields:
    # =========================================================================
    # TOP-LEVEL FIELDS
    # =========================================================================
    - name: userProfilePK
      json_path: "$.userProfilePK"
      bq_type: INT64
      mode: REQUIRED
      description: "Garmin user profile primary key"
      validations:
        - type: not_null
        - type: positive

    - name: startDate
      json_path: "$.startDate"
      bq_type: DATE
      mode: REQUIRED
      description: "Start date of endurance score period (used for partitioning)"
      transform: "string_to_date"
      validations:
        - type: not_null

    - name: endDate
      json_path: "$.endDate"
      bq_type: DATE
      mode: REQUIRED
      description: "End date of endurance score period"
      transform: "string_to_date"
      validations:
        - type: not_null

    - name: avg
      json_path: "$.avg"
      bq_type: INT64
      mode: NULLABLE
      description: "Average endurance score for the period"
      validations:
        - type: range
          min: 0
          max: 15000

    - name: max
      json_path: "$.max"
      bq_type: INT64
      mode: NULLABLE
      description: "Maximum endurance score for the period"
      validations:
        - type: range
          min: 0
          max: 15000

    # =========================================================================
    # ENDURANCE SCORE DTO (RECORD)
    # =========================================================================
    - name: enduranceScoreDTO
      bq_type: RECORD
      mode: NULLABLE
      json_path: "$.enduranceScoreDTO"
      description: "Current endurance score details with classification and limits"
      fields:
        - name: userProfilePK
          json_path: "$.userProfilePK"
          bq_type: INT64
          mode: NULLABLE
          description: "User profile PK (duplicate of top-level)"

        - name: deviceId
          json_path: "$.deviceId"
          bq_type: INT64
          mode: NULLABLE
          description: "Device ID that recorded the score"

        - name: calendarDate
          json_path: "$.calendarDate"
          bq_type: DATE
          mode: NULLABLE
          description: "Calendar date of the score"
          transform: "string_to_date"

        - name: overallScore
          json_path: "$.overallScore"
          bq_type: INT64
          mode: NULLABLE
          description: "Overall endurance score"
          validations:
            - type: range
              min: 0
              max: 15000

        - name: classification
          json_path: "$.classification"
          bq_type: INT64
          mode: NULLABLE
          description: "Classification level (0=Beginner, 1=Intermediate, 2=Trained, 3=Well Trained, 4=Expert, 5=Superior, 6=Elite)"
          validations:
            - type: range
              min: 0
              max: 6

        - name: feedbackPhrase
          json_path: "$.feedbackPhrase"
          bq_type: INT64
          mode: NULLABLE
          description: "Feedback phrase ID"

        - name: primaryTrainingDevice
          json_path: "$.primaryTrainingDevice"
          bq_type: BOOL
          mode: NULLABLE
          description: "Whether this is the primary training device"

        # Classification Limits
        - name: gaugeLowerLimit
          json_path: "$.gaugeLowerLimit"
          bq_type: INT64
          mode: NULLABLE
          description: "Gauge lower limit for scoring"

        - name: gaugeUpperLimit
          json_path: "$.gaugeUpperLimit"
          bq_type: INT64
          mode: NULLABLE
          description: "Gauge upper limit for scoring"

        - name: classificationLowerLimitIntermediate
          json_path: "$.classificationLowerLimitIntermediate"
          bq_type: INT64
          mode: NULLABLE
          description: "Lower limit for Intermediate classification"

        - name: classificationLowerLimitTrained
          json_path: "$.classificationLowerLimitTrained"
          bq_type: INT64
          mode: NULLABLE
          description: "Lower limit for Trained classification"

        - name: classificationLowerLimitWellTrained
          json_path: "$.classificationLowerLimitWellTrained"
          bq_type: INT64
          mode: NULLABLE
          description: "Lower limit for Well Trained classification"

        - name: classificationLowerLimitExpert
          json_path: "$.classificationLowerLimitExpert"
          bq_type: INT64
          mode: NULLABLE
          description: "Lower limit for Expert classification"

        - name: classificationLowerLimitSuperior
          json_path: "$.classificationLowerLimitSuperior"
          bq_type: INT64
          mode: NULLABLE
          description: "Lower limit for Superior classification"

        - name: classificationLowerLimitElite
          json_path: "$.classificationLowerLimitElite"
          bq_type: INT64
          mode: NULLABLE
          description: "Lower limit for Elite classification"

    # =========================================================================
    # CONTRIBUTORS (REPEATED RECORD)
    # =========================================================================
    - name: contributors
      bq_type: RECORD
      mode: REPEATED
      json_path: "$.enduranceScoreDTO.contributors"
      description: "Activity type contributions to endurance score"
      fields:
        - name: activityTypeId
          json_path: "$.activityTypeId"
          bq_type: INT64
          mode: NULLABLE
          description: "Activity type ID (null = group category)"

        - name: group
          json_path: "$.group"
          bq_type: INT64
          mode: NULLABLE
          description: "Activity group ID (0=Aerobic, 8=Anaerobic)"

        - name: contribution
          json_path: "$.contribution"
          bq_type: FLOAT64
          mode: NULLABLE
          description: "Percentage contribution to endurance score"
          validations:
            - type: range
              min: 0
              max: 100

  # ===========================================================================
  # EXTENDED FIELDS
  # ===========================================================================
  extended_fields_reference:
    note: "groupMap has dynamic date keys and cannot be mapped to static RECORD fields"
    storage: "Stored in raw_data JSON for flexible querying"
    structure: |
      groupMap: {
        "2025-10-13": {
          groupAverage: INT,
          groupMax: INT,
          enduranceContributorDTOList: [{
            activityTypeId: INT,
            group: INT,
            contribution: FLOAT
          }]
        },
        "2025-10-20": { ... }
      }
    query_example: |
      SELECT
        userProfilePK,
        startDate,
        JSON_EXTRACT_SCALAR(raw_data, '$.groupMap.2025-10-13.groupAverage') AS score_2025_10_13
      FROM lake_garmin__endurance_score_normalized

# =============================================================================
# METADATA FIELDS
# =============================================================================
metadata_fields:
  - name: raw_data
    bq_type: JSON
    mode: NULLABLE
    description: "Complete endurance score JSON including groupMap with dynamic date keys"

  - name: dp_inserted_at
    bq_type: TIMESTAMP
    mode: REQUIRED
    description: "Timestamp when record was ingested"
    default: "CURRENT_TIMESTAMP"

  - name: source_file
    bq_type: STRING
    mode: NULLABLE
    description: "Source JSONL filename"

# =============================================================================
# QUALITY CHECKS
# =============================================================================
quality_checks:
  unique_key: userProfilePK
  deduplication_strategy: "keep_latest"

  required_fields:
    - userProfilePK
    - startDate
    - endDate

  validation_mode: "warn"

  null_handling:
    strategy: "allow"
    replacement_values: {}

# =============================================================================
# TRANSFORMATIONS
# =============================================================================
transformations:
  string_to_date:
    description: "Convert YYYY-MM-DD string to DATE"
    logic: "datetime.strptime(value, '%Y-%m-%d').date()"

# =============================================================================
# PERFORMANCE CONFIGURATION
# =============================================================================
performance:
  batch_size: 500
  max_batch_size_mb: 10
  max_workers: 4
  parallel_file_limit: 10
  max_memory_mb: 2048
  stream_large_files: true
  bq_job_timeout_seconds: 600
  gcs_download_timeout: 300

  retry:
    enabled: true
    max_attempts: 3
    backoff_seconds: 5
    backoff_multiplier: 2

# =============================================================================
# LOGGING
# =============================================================================
logging:
  level: INFO
  console: true
  file: false
  include_sample_records: true
  max_sample_records: 3
  log_rejected_records: true
  log_validation_failures: true
  track_metrics: true

# =============================================================================
# ALERTING
# =============================================================================
alerting:
  enabled: false

  conditions:
    - name: high_rejection_rate
      threshold: 0.1

    - name: no_data
      threshold: 0

    - name: processing_time
      threshold: 600

  channels:
    - email
    - slack

# =============================================================================
# EXAMPLES
# =============================================================================
examples:
  - name: "Ingest endurance_score to dev"
    command: "python -m src.connectors.garmin.garmin_ingest_v2 --config endurance_score --env dev"

  - name: "Ingest endurance_score to prod"
    command: "python -m src.connectors.garmin.garmin_ingest_v2 --config endurance_score --env prd"

  - name: "Dry run"
    command: "python -m src.connectors.garmin.garmin_ingest_v2 --config endurance_score --env dev --dry-run"

  - name: "Verbose logging"
    command: "python -m src.connectors.garmin.garmin_ingest_v2 --config endurance_score --env dev --log-level DEBUG"

# =============================================================================
# NOTES
# =============================================================================
notes: |
  GARMIN ENDURANCE SCORE:

  Endurance score measures aerobic and anaerobic fitness combining:
  - VO2 max
  - Training history
  - Activity types (running, cycling, swimming, etc.)
  - Training load balance

  Classification levels:
  0. Beginner (< 5100)
  1. Intermediate (5100-5799)
  2. Trained (5800-6599)
  3. Well Trained (6600-7299)
  4. Expert (7300-8099)
  5. Superior (8100-8799)
  6. Elite (8800+)

  Contributors:
  - group 0: Aerobic activities (running, cycling, swimming)
  - group 8: Anaerobic activities (HIIT, strength training)
  - activityTypeId: Specific activity type (9=running, 13=cycling, etc.)

  Data structure:
  - Top-level: Weekly summary (startDate to endDate)
  - enduranceScoreDTO: Current score with classification
  - contributors: Activity type breakdown of endurance score
  - groupMap: Historical weekly scores (dynamic date keys, stored in raw_data)

  Query examples:

  # Current endurance score with classification
  SELECT
    userProfilePK,
    startDate,
    endDate,
    avg AS avg_score,
    max AS max_score,
    enduranceScoreDTO.overallScore,
    enduranceScoreDTO.classification,
    CASE enduranceScoreDTO.classification
      WHEN 0 THEN 'Beginner'
      WHEN 1 THEN 'Intermediate'
      WHEN 2 THEN 'Trained'
      WHEN 3 THEN 'Well Trained'
      WHEN 4 THEN 'Expert'
      WHEN 5 THEN 'Superior'
      WHEN 6 THEN 'Elite'
    END AS classification_label,
    enduranceScoreDTO.calendarDate
  FROM `lake_garmin__endurance_score_normalized`
  WHERE startDate >= '2025-10-01'
  ORDER BY startDate DESC;

  # Activity type contributions
  SELECT
    userProfilePK,
    startDate,
    enduranceScoreDTO.overallScore,
    contributor.activityTypeId,
    contributor.group,
    contributor.contribution,
    CASE contributor.group
      WHEN 0 THEN 'Aerobic'
      WHEN 8 THEN 'Anaerobic'
    END AS group_name
  FROM `lake_garmin__endurance_score_normalized`,
  UNNEST(contributors) AS contributor
  WHERE startDate >= '2025-10-01'
  ORDER BY startDate DESC, contributor.contribution DESC;

  # Endurance score trends
  SELECT
    userProfilePK,
    startDate,
    endDate,
    avg AS avg_score,
    LAG(avg) OVER (PARTITION BY userProfilePK ORDER BY startDate) AS prev_week_score,
    avg - LAG(avg) OVER (PARTITION BY userProfilePK ORDER BY startDate) AS score_change
  FROM `lake_garmin__endurance_score_normalized`
  WHERE avg IS NOT NULL
  ORDER BY userProfilePK, startDate;

  # Classification distribution
  SELECT
    enduranceScoreDTO.classification,
    CASE enduranceScoreDTO.classification
      WHEN 0 THEN 'Beginner'
      WHEN 1 THEN 'Intermediate'
      WHEN 2 THEN 'Trained'
      WHEN 3 THEN 'Well Trained'
      WHEN 4 THEN 'Expert'
      WHEN 5 THEN 'Superior'
      WHEN 6 THEN 'Elite'
    END AS classification_label,
    COUNT(DISTINCT userProfilePK) AS user_count,
    AVG(enduranceScoreDTO.overallScore) AS avg_score,
    MIN(enduranceScoreDTO.overallScore) AS min_score,
    MAX(enduranceScoreDTO.overallScore) AS max_score
  FROM `lake_garmin__endurance_score_normalized`
  WHERE startDate >= '2025-10-01'
  GROUP BY 1, 2
  ORDER BY 1;

  # Extract historical scores from groupMap
  SELECT
    userProfilePK,
    startDate,
    JSON_EXTRACT_SCALAR(raw_data, '$.groupMap.2025-10-13.groupAverage') AS score_2025_10_13,
    JSON_EXTRACT_SCALAR(raw_data, '$.groupMap.2025-10-20.groupAverage') AS score_2025_10_20
  FROM `lake_garmin__endurance_score_normalized`
  WHERE raw_data IS NOT NULL;
