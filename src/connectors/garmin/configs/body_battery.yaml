# =============================================================================
# GARMIN BODY BATTERY - COMPLETE INGESTION CONFIGURATION
# =============================================================================
# This configuration handles Body Battery data with time-series arrays and events.
#
# Structure:
# - Top-level: date, charged/drained totals, timestamps
# - bodyBatteryValuesArray: Time-series data (timestamp, level)
# - bodyBatteryActivityEvent: REPEATED RECORD (SLEEP/RECOVERY/ACTIVITY events)
# - bodyBatteryDynamicFeedbackEvent: Current feedback RECORD
# - endOfDayBodyBatteryDynamicFeedbackEvent: End of day feedback RECORD
# =============================================================================

data_type: body_battery
description: "Garmin Body Battery data with time-series and activity events"
version: "1.0.0"
owner: "data-platform"
last_updated: "2025-10-31"

# =============================================================================
# SOURCE CONFIGURATION
# =============================================================================
source:
  bucket_pattern: "ela-dp-{env}"
  landing_path: "garmin/landing"
  file_pattern: "*_body_battery.jsonl"
  archive_path: "garmin/archive"
  rejected_path: "garmin/rejected"
  delete_after_archive: false
  max_file_age_days: 30

# =============================================================================
# DESTINATION CONFIGURATION
# =============================================================================
destination:
  project_id: "${GCP_PROJECT_ID}"
  dataset_pattern: "dp_lake_{env}"
  table_name: "lake_garmin__normalized_body_battery"
  write_disposition: "WRITE_APPEND"
  create_disposition: "CREATE_IF_NEEDED"

  partition:
    enabled: true
    field: "dp_inserted_at"
    type: "DAY"
    expiration_days: null

  clustering:
    enabled: true
    fields:
      - "date"

# =============================================================================
# PARSING CONFIGURATION
# =============================================================================
parsing:
  strategy: "hybrid"

  core_fields:
    # =========================================================================
    # IDENTIFIERS & TIMESTAMPS
    # =========================================================================
    - name: date
      json_path: "$.date"
      bq_type: DATE
      mode: REQUIRED
      description: "Date of Body Battery data (used for partitioning)"
      transform: "string_to_date"
      validations:
        - type: not_null

    - name: startTimestampGMT
      json_path: "$.startTimestampGMT"
      bq_type: TIMESTAMP
      mode: NULLABLE
      description: "Start timestamp GMT"
      transform: "string_to_timestamp"

    - name: endTimestampGMT
      json_path: "$.endTimestampGMT"
      bq_type: TIMESTAMP
      mode: NULLABLE
      description: "End timestamp GMT"
      transform: "string_to_timestamp"

    - name: startTimestampLocal
      json_path: "$.startTimestampLocal"
      bq_type: TIMESTAMP
      mode: NULLABLE
      description: "Start timestamp local"
      transform: "string_to_timestamp"

    - name: endTimestampLocal
      json_path: "$.endTimestampLocal"
      bq_type: TIMESTAMP
      mode: NULLABLE
      description: "End timestamp local"
      transform: "string_to_timestamp"

    # =========================================================================
    # DAILY TOTALS
    # =========================================================================
    - name: charged
      json_path: "$.charged"
      bq_type: INT64
      mode: NULLABLE
      description: "Total Body Battery charged during day"

    - name: drained
      json_path: "$.drained"
      bq_type: INT64
      mode: NULLABLE
      description: "Total Body Battery drained during day"

    # =========================================================================
    # BODY BATTERY VALUES (REPEATED RECORD with array_index)
    # =========================================================================
    - name: bodyBatteryValues
      bq_type: RECORD
      mode: REPEATED
      json_path: "$.bodyBatteryValuesArray"
      description: "Body Battery time-series measurements"
      fields:
        - name: timestamp
          array_index: 0
          bq_type: TIMESTAMP
          mode: NULLABLE
          description: "Measurement timestamp (epoch milliseconds)"
          transform: "timestamp_ms_to_timestamp"

        - name: bodyBatteryLevel
          array_index: 1
          bq_type: INT64
          mode: NULLABLE
          description: "Body Battery level (0-100)"

    # =========================================================================
    # DYNAMIC FEEDBACK EVENT (RECORD)
    # =========================================================================
    - name: bodyBatteryDynamicFeedbackEvent
      bq_type: RECORD
      mode: NULLABLE
      json_path: "$.bodyBatteryDynamicFeedbackEvent"
      description: "Current Body Battery feedback"
      fields:
        - name: eventTimestampGmt
          json_path: "$.eventTimestampGmt"
          bq_type: TIMESTAMP
          mode: NULLABLE
          description: "Event timestamp GMT"
          transform: "string_to_timestamp"

        - name: bodyBatteryLevel
          json_path: "$.bodyBatteryLevel"
          bq_type: STRING
          mode: NULLABLE
          description: "Body Battery level category (LOW, MODERATE, HIGH)"

        - name: feedbackShortType
          json_path: "$.feedbackShortType"
          bq_type: STRING
          mode: NULLABLE
          description: "Short feedback type"

        - name: feedbackLongType
          json_path: "$.feedbackLongType"
          bq_type: STRING
          mode: NULLABLE
          description: "Long feedback type"

    # =========================================================================
    # END OF DAY FEEDBACK EVENT (RECORD)
    # =========================================================================
    - name: endOfDayBodyBatteryDynamicFeedbackEvent
      bq_type: RECORD
      mode: NULLABLE
      json_path: "$.endOfDayBodyBatteryDynamicFeedbackEvent"
      description: "End of day Body Battery feedback"
      fields:
        - name: eventTimestampGmt
          json_path: "$.eventTimestampGmt"
          bq_type: TIMESTAMP
          mode: NULLABLE
          description: "Event timestamp GMT"
          transform: "string_to_timestamp"

        - name: bodyBatteryLevel
          json_path: "$.bodyBatteryLevel"
          bq_type: STRING
          mode: NULLABLE
          description: "Body Battery level category (LOW, MODERATE, HIGH)"

        - name: feedbackShortType
          json_path: "$.feedbackShortType"
          bq_type: STRING
          mode: NULLABLE
          description: "Short feedback type"

        - name: feedbackLongType
          json_path: "$.feedbackLongType"
          bq_type: STRING
          mode: NULLABLE
          description: "Long feedback type"

    # =========================================================================
    # ACTIVITY EVENTS (REPEATED RECORD)
    # =========================================================================
    - name: bodyBatteryActivityEvent
      bq_type: RECORD
      mode: REPEATED
      json_path: "$.bodyBatteryActivityEvent"
      description: "Activity events affecting Body Battery (SLEEP, RECOVERY, ACTIVITY)"
      fields:
        - name: eventType
          json_path: "$.eventType"
          bq_type: STRING
          mode: NULLABLE
          description: "Event type: SLEEP, RECOVERY, ACTIVITY"

        - name: eventStartTimeGmt
          json_path: "$.eventStartTimeGmt"
          bq_type: TIMESTAMP
          mode: NULLABLE
          description: "Event start time GMT"
          transform: "string_to_timestamp"

        - name: timezoneOffset
          json_path: "$.timezoneOffset"
          bq_type: INT64
          mode: NULLABLE
          description: "Timezone offset in milliseconds"

        - name: durationInMilliseconds
          json_path: "$.durationInMilliseconds"
          bq_type: INT64
          mode: NULLABLE
          description: "Event duration in milliseconds"

        - name: bodyBatteryImpact
          json_path: "$.bodyBatteryImpact"
          bq_type: INT64
          mode: NULLABLE
          description: "Impact on Body Battery (positive = charged, negative = drained)"

        - name: feedbackType
          json_path: "$.feedbackType"
          bq_type: STRING
          mode: NULLABLE
          description: "Feedback type for the event"

        - name: shortFeedback
          json_path: "$.shortFeedback"
          bq_type: STRING
          mode: NULLABLE
          description: "Short feedback message"

  # ===========================================================================
  # EXTENDED FIELDS
  # ===========================================================================
  extended_fields_reference:
    note: "All 32 paths are included as core fields - no extended fields needed"

# =============================================================================
# METADATA FIELDS
# =============================================================================
metadata_fields:
  - name: raw_data
    bq_type: JSON
    mode: NULLABLE
    description: "Complete Body Battery JSON for reference"

  - name: dp_inserted_at
    bq_type: TIMESTAMP
    mode: REQUIRED
    description: "Timestamp when record was ingested"
    default: "CURRENT_TIMESTAMP"

  - name: source_file
    bq_type: STRING
    mode: NULLABLE
    description: "Source JSONL filename"

# =============================================================================
# QUALITY CHECKS
# =============================================================================
quality_checks:
  unique_key: date
  deduplication_strategy: "keep_latest"

  required_fields:
    - date

  validation_mode: "warn"

  null_handling:
    strategy: "allow"
    replacement_values: {}

# =============================================================================
# TRANSFORMATIONS
# =============================================================================
transformations:
  string_to_timestamp:
    description: "Convert ISO string to TIMESTAMP"
    logic: "datetime.fromisoformat(value.replace('.0', ''))"

  string_to_date:
    description: "Convert YYYY-MM-DD string to DATE"
    logic: "datetime.strptime(value, '%Y-%m-%d').date()"

  timestamp_ms_to_timestamp:
    description: "Convert milliseconds epoch to TIMESTAMP"
    logic: "datetime.fromtimestamp(value / 1000)"

# =============================================================================
# PERFORMANCE CONFIGURATION
# =============================================================================
performance:
  batch_size: 500
  max_batch_size_mb: 10
  max_workers: 4
  parallel_file_limit: 10
  max_memory_mb: 2048
  stream_large_files: true
  bq_job_timeout_seconds: 600
  gcs_download_timeout: 300

  retry:
    enabled: true
    max_attempts: 3
    backoff_seconds: 5
    backoff_multiplier: 2

# =============================================================================
# LOGGING
# =============================================================================
logging:
  level: INFO
  console: true
  file: false
  include_sample_records: true
  max_sample_records: 3
  log_rejected_records: true
  log_validation_failures: true
  track_metrics: true

# =============================================================================
# ALERTING
# =============================================================================
alerting:
  enabled: false

  conditions:
    - name: high_rejection_rate
      threshold: 0.1

    - name: no_data
      threshold: 0

    - name: processing_time
      threshold: 600

  channels:
    - email
    - slack

# =============================================================================
# EXAMPLES
# =============================================================================
examples:
  - name: "Ingest body_battery to dev"
    command: "python -m src.connectors.garmin.garmin_ingest_v2 --config body_battery --env dev"

  - name: "Ingest body_battery to prod"
    command: "python -m src.connectors.garmin.garmin_ingest_v2 --config body_battery --env prd"

  - name: "Dry run"
    command: "python -m src.connectors.garmin.garmin_ingest_v2 --config body_battery --env dev --dry-run"

  - name: "Verbose logging"
    command: "python -m src.connectors.garmin.garmin_ingest_v2 --config body_battery --env dev --log-level DEBUG"

# =============================================================================
# NOTES
# =============================================================================
notes: |
  GARMIN BODY BATTERY DATA:

  Body Battery measures energy levels throughout the day based on:
  - Sleep quality and duration
  - Physical activity and exercise
  - Recovery periods
  - Stress levels

  Data structure:
  1. Daily totals (charged/drained)
  2. Time-series measurements (bodyBatteryValuesArray)
  3. Activity events (SLEEP, RECOVERY, ACTIVITY) with impact
  4. Dynamic feedback (current and end-of-day)

  Query examples:

  # Daily summary
  SELECT
    date,
    charged,
    drained,
    charged - drained AS net_change
  FROM `lake_garmin__body_battery_normalized`
  ORDER BY date DESC;

  # Activity event analysis
  SELECT
    date,
    event.eventType,
    event.bodyBatteryImpact,
    event.durationInMilliseconds / 3600000 AS duration_hours,
    event.feedbackType
  FROM `lake_garmin__body_battery_normalized`,
  UNNEST(bodyBatteryActivityEvent) AS event
  WHERE event.eventType = 'SLEEP'
  ORDER BY date DESC;

  # Body Battery level distribution
  SELECT
    date,
    bb.timestamp,
    bb.bodyBatteryLevel
  FROM `lake_garmin__body_battery_normalized`,
  UNNEST(bodyBatteryValues) AS bb
  WHERE date >= '2025-09-01'
  ORDER BY date, bb.timestamp;
