# =============================================================================
# GARMIN ACTIVITY WEATHER - COMPLETE INGESTION CONFIGURATION
# =============================================================================
# This configuration handles Garmin activity weather data.
#
# Structure:
# - Activity info: activityId, activityName, startTimeLocal
# - Activity type: typeId, typeKey, parentTypeId, flags
# - Weather data: temp, humidity, wind, location
# - Weather station: id, name, timezone
# - Weather type: description, image
# =============================================================================

data_type: activity_weather
description: "Garmin activity weather conditions at activity start time"
version: "1.0.0"
owner: "data-platform"
last_updated: "2025-11-01"

# =============================================================================
# SOURCE CONFIGURATION
# =============================================================================
source:
  bucket_pattern: "ela-dp-{env}"
  landing_path: "garmin/landing"
  file_pattern: "*_activity_weather.jsonl"
  archive_path: "garmin/archive"
  rejected_path: "garmin/rejected"
  delete_after_archive: false
  max_file_age_days: 30

# =============================================================================
# DESTINATION CONFIGURATION
# =============================================================================
destination:
  project_id: "${GCP_PROJECT_ID}"
  dataset_pattern: "dp_lake_{env}"
  table_name: "lake_garmin__normalized_activity_weather"
  write_disposition: "WRITE_APPEND"
  create_disposition: "CREATE_IF_NEEDED"

  partition:
    enabled: true
    field: "dp_inserted_at"
    type: "DAY"
    expiration_days: null

  clustering:
    enabled: true
    fields:
      - "activityId"
      - "startTimeLocal"

# =============================================================================
# PARSING CONFIGURATION
# =============================================================================
parsing:
  strategy: "hybrid"

  core_fields:
    # =========================================================================
    # ACTIVITY IDENTIFICATION
    # =========================================================================
    - name: activityId
      json_path: "$.activityId"
      bq_type: INT64
      mode: REQUIRED
      description: "Garmin activity ID (foreign key to activities table)"
      validations:
        - type: not_null
        - type: positive

    - name: activityName
      json_path: "$.activityName"
      bq_type: STRING
      mode: NULLABLE
      description: "Activity name (user-defined)"

    - name: startTimeLocal
      json_path: "$.startTimeLocal"
      bq_type: TIMESTAMP
      mode: REQUIRED
      description: "Activity start time in local timezone (used for partitioning)"
      transform: "string_to_timestamp_space"
      validations:
        - type: not_null

    - name: data_type
      json_path: "$.data_type"
      bq_type: STRING
      mode: NULLABLE
      description: "Data type identifier (always 'activity_weather')"

    # =========================================================================
    # ACTIVITY TYPE (RECORD)
    # =========================================================================
    - name: activityType
      bq_type: RECORD
      mode: NULLABLE
      json_path: "$.activityType"
      description: "Activity type details"
      fields:
        - name: typeId
          json_path: "$.typeId"
          bq_type: INT64
          mode: NULLABLE
          description: "Activity type ID (1=running, 2=cycling, etc.)"

        - name: typeKey
          json_path: "$.typeKey"
          bq_type: STRING
          mode: NULLABLE
          description: "Activity type key (running, cycling, swimming, etc.)"

        - name: parentTypeId
          json_path: "$.parentTypeId"
          bq_type: INT64
          mode: NULLABLE
          description: "Parent activity type ID"

        - name: isHidden
          json_path: "$.isHidden"
          bq_type: BOOL
          mode: NULLABLE
          description: "Whether activity type is hidden"

        - name: restricted
          json_path: "$.restricted"
          bq_type: BOOL
          mode: NULLABLE
          description: "Whether activity type is restricted"

        - name: trimmable
          json_path: "$.trimmable"
          bq_type: BOOL
          mode: NULLABLE
          description: "Whether activity can be trimmed"

    # =========================================================================
    # WEATHER DATA (RECORD)
    # =========================================================================
    - name: weatherData
      bq_type: RECORD
      mode: NULLABLE
      json_path: "$.weather_data"
      description: "Weather conditions at activity start"
      fields:
        - name: issueDate
          json_path: "$.issueDate"
          bq_type: TIMESTAMP
          mode: NULLABLE
          description: "Weather data issue timestamp"
          transform: "string_to_timestamp"

        - name: temp
          json_path: "$.temp"
          bq_type: INT64
          mode: NULLABLE
          description: "Temperature in Fahrenheit"
          validations:
            - type: range
              min: -50
              max: 150

        - name: apparentTemp
          json_path: "$.apparentTemp"
          bq_type: INT64
          mode: NULLABLE
          description: "Apparent temperature (feels like) in Fahrenheit"
          validations:
            - type: range
              min: -50
              max: 150

        - name: dewPoint
          json_path: "$.dewPoint"
          bq_type: INT64
          mode: NULLABLE
          description: "Dew point in Fahrenheit"
          validations:
            - type: range
              min: -50
              max: 150

        - name: relativeHumidity
          json_path: "$.relativeHumidity"
          bq_type: INT64
          mode: NULLABLE
          description: "Relative humidity percentage (0-100)"
          validations:
            - type: range
              min: 0
              max: 100

        - name: windDirection
          json_path: "$.windDirection"
          bq_type: INT64
          mode: NULLABLE
          description: "Wind direction in degrees (0-360)"
          validations:
            - type: range
              min: 0
              max: 360

        - name: windDirectionCompassPoint
          json_path: "$.windDirectionCompassPoint"
          bq_type: STRING
          mode: NULLABLE
          description: "Wind direction compass point (n, ne, e, se, s, sw, w, nw)"

        - name: windSpeed
          json_path: "$.windSpeed"
          bq_type: INT64
          mode: NULLABLE
          description: "Wind speed in mph"
          validations:
            - type: range
              min: 0
              max: 200

        - name: windGust
          json_path: "$.windGust"
          bq_type: INT64
          mode: NULLABLE
          description: "Wind gust speed in mph"
          validations:
            - type: range
              min: 0
              max: 200

        - name: latitude
          json_path: "$.latitude"
          bq_type: FLOAT64
          mode: NULLABLE
          description: "Weather observation latitude"
          validations:
            - type: range
              min: -90
              max: 90

        - name: longitude
          json_path: "$.longitude"
          bq_type: FLOAT64
          mode: NULLABLE
          description: "Weather observation longitude"
          validations:
            - type: range
              min: -180
              max: 180

        # =====================================================================
        # WEATHER STATION (NESTED RECORD)
        # =====================================================================
        - name: weatherStationDTO
          bq_type: RECORD
          mode: NULLABLE
          json_path: "$.weatherStationDTO"
          description: "Weather station information"
          fields:
            - name: id
              json_path: "$.id"
              bq_type: STRING
              mode: NULLABLE
              description: "Weather station ID (ICAO code, e.g., LFRN)"

            - name: name
              json_path: "$.name"
              bq_type: STRING
              mode: NULLABLE
              description: "Weather station name (e.g., Rennes)"

            - name: timezone
              json_path: "$.timezone"
              bq_type: STRING
              mode: NULLABLE
              description: "Weather station timezone"

        # =====================================================================
        # WEATHER TYPE (NESTED RECORD)
        # =====================================================================
        - name: weatherTypeDTO
          bq_type: RECORD
          mode: NULLABLE
          json_path: "$.weatherTypeDTO"
          description: "Weather type/condition description"
          fields:
            - name: weatherTypePk
              json_path: "$.weatherTypePk"
              bq_type: INT64
              mode: NULLABLE
              description: "Weather type primary key"

            - name: desc
              json_path: "$.desc"
              bq_type: STRING
              mode: NULLABLE
              description: "Weather description (Mostly Clear, Rainy, Cloudy, etc.)"

            - name: image
              json_path: "$.image"
              bq_type: STRING
              mode: NULLABLE
              description: "Weather icon image URL"

  # ===========================================================================
  # EXTENDED FIELDS
  # ===========================================================================
  extended_fields_reference:
    note: "All 31 JSON paths are mapped as core fields - no extended fields needed"

# =============================================================================
# METADATA FIELDS
# =============================================================================
metadata_fields:
  - name: raw_data
    bq_type: JSON
    mode: NULLABLE
    description: "Complete activity weather JSON"

  - name: dp_inserted_at
    bq_type: TIMESTAMP
    mode: REQUIRED
    description: "Timestamp when record was ingested"
    default: "CURRENT_TIMESTAMP"

  - name: source_file
    bq_type: STRING
    mode: NULLABLE
    description: "Source JSONL filename"

# =============================================================================
# QUALITY CHECKS
# =============================================================================
quality_checks:
  unique_key: activityId
  deduplication_strategy: "keep_latest"

  required_fields:
    - activityId
    - startTimeLocal

  validation_mode: "warn"

  null_handling:
    strategy: "allow"
    replacement_values: {}

# =============================================================================
# TRANSFORMATIONS
# =============================================================================
transformations:
  string_to_timestamp:
    description: "Convert ISO string to TIMESTAMP"
    logic: "datetime.fromisoformat(value.replace('.0000+00:00', '+00:00').replace('.000+00:00', '+00:00'))"

  string_to_timestamp_space:
    description: "Convert 'YYYY-MM-DD HH:MM:SS' string to TIMESTAMP"
    logic: "datetime.strptime(value, '%Y-%m-%d %H:%M:%S')"

# =============================================================================
# PERFORMANCE CONFIGURATION
# =============================================================================
performance:
  batch_size: 500
  max_batch_size_mb: 10
  max_workers: 4
  parallel_file_limit: 10
  max_memory_mb: 2048
  stream_large_files: true
  bq_job_timeout_seconds: 600
  gcs_download_timeout: 300

  retry:
    enabled: true
    max_attempts: 3
    backoff_seconds: 5
    backoff_multiplier: 2

# =============================================================================
# LOGGING
# =============================================================================
logging:
  level: INFO
  console: true
  file: false
  include_sample_records: true
  max_sample_records: 3
  log_rejected_records: true
  log_validation_failures: true
  track_metrics: true

# =============================================================================
# ALERTING
# =============================================================================
alerting:
  enabled: false

  conditions:
    - name: high_rejection_rate
      threshold: 0.1

    - name: no_data
      threshold: 0

    - name: processing_time
      threshold: 600

  channels:
    - email
    - slack

# =============================================================================
# EXAMPLES
# =============================================================================
examples:
  - name: "Ingest activity_weather to dev"
    command: "python -m src.connectors.garmin.garmin_ingest_v2 --config activity_weather --env dev"

  - name: "Ingest activity_weather to prod"
    command: "python -m src.connectors.garmin.garmin_ingest_v2 --config activity_weather --env prd"

  - name: "Dry run"
    command: "python -m src.connectors.garmin.garmin_ingest_v2 --config activity_weather --env dev --dry-run"

  - name: "Verbose logging"
    command: "python -m src.connectors.garmin.garmin_ingest_v2 --config activity_weather --env dev --log-level DEBUG"

# =============================================================================
# NOTES
# =============================================================================
notes: |
  GARMIN ACTIVITY WEATHER:

  Weather conditions at the start of each activity, providing context for:
  - Performance analysis (heat/cold impact)
  - Training adaptation (weather-specific training)
  - Safety considerations (extreme conditions)

  Temperature units: Fahrenheit
  Wind speed units: mph
  Humidity: percentage (0-100)
  Wind direction: degrees (0-360) + compass point (n, ne, e, se, s, sw, w, nw)

  Weather station: ICAO code (International Civil Aviation Organization)
  - LFRN: Rennes, France
  - LFPG: Paris Charles de Gaulle, France
  - KJFK: New York JFK, USA

  Common weather descriptions:
  - Mostly Clear
  - Partly Cloudy
  - Cloudy
  - Overcast
  - Light Rain
  - Rain
  - Heavy Rain
  - Thunderstorms
  - Snow
  - Fog

  Use cases:
  1. Join with activities table for weather-enriched activity analysis
  2. Identify activities in extreme weather conditions
  3. Analyze performance correlation with temperature/humidity
  4. Track training adaptation to weather conditions

  Query examples:

  # Activities with weather conditions
  SELECT
    a.activityId,
    a.activityName,
    a.startTimeLocal,
    a.activityType.typeKey AS activity_type,
    w.weatherData.temp AS temp_fahrenheit,
    (w.weatherData.temp - 32) * 5 / 9 AS temp_celsius,
    w.weatherData.apparentTemp AS feels_like,
    w.weatherData.relativeHumidity AS humidity,
    w.weatherData.windSpeed AS wind_mph,
    w.weatherData.windDirectionCompassPoint AS wind_dir,
    w.weatherData.weatherTypeDTO.desc AS weather_desc
  FROM `lake_garmin__activity_weather_normalized` w
  WHERE w.startTimeLocal >= '2025-10-01'
  ORDER BY w.startTimeLocal DESC;

  # Extreme weather activities
  SELECT
    activityId,
    activityName,
    startTimeLocal,
    weatherData.temp AS temp_f,
    weatherData.relativeHumidity AS humidity,
    weatherData.weatherTypeDTO.desc AS conditions,
    CASE
      WHEN weatherData.temp < 32 THEN 'FREEZING'
      WHEN weatherData.temp < 40 THEN 'COLD'
      WHEN weatherData.temp > 85 THEN 'HOT'
      WHEN weatherData.temp > 95 THEN 'EXTREME_HEAT'
      ELSE 'MODERATE'
    END AS temp_category
  FROM `lake_garmin__activity_weather_normalized`
  WHERE startTimeLocal >= '2025-10-01'
    AND (weatherData.temp < 40 OR weatherData.temp > 85)
  ORDER BY weatherData.temp;

  # Weather statistics by activity type
  SELECT
    activityType.typeKey AS activity_type,
    COUNT(*) AS activity_count,
    ROUND(AVG(weatherData.temp), 1) AS avg_temp_f,
    ROUND(AVG(weatherData.relativeHumidity), 1) AS avg_humidity,
    ROUND(AVG(weatherData.windSpeed), 1) AS avg_wind_mph,
    MAX(weatherData.temp) AS max_temp,
    MIN(weatherData.temp) AS min_temp
  FROM `lake_garmin__activity_weather_normalized`
  WHERE startTimeLocal >= '2025-10-01'
  GROUP BY activity_type
  ORDER BY activity_count DESC;

  # Weather stations used
  SELECT
    weatherData.weatherStationDTO.id AS station_id,
    weatherData.weatherStationDTO.name AS station_name,
    COUNT(*) AS activity_count,
    ROUND(AVG(weatherData.latitude), 4) AS avg_lat,
    ROUND(AVG(weatherData.longitude), 4) AS avg_lon
  FROM `lake_garmin__activity_weather_normalized`
  WHERE startTimeLocal >= '2025-10-01'
  GROUP BY station_id, station_name
  ORDER BY activity_count DESC;

  # Temperature conversion helpers
  -- Fahrenheit to Celsius: (F - 32) * 5 / 9
  -- Celsius to Fahrenheit: (C * 9 / 5) + 32
  -- mph to km/h: mph * 1.60934
  -- km/h to mph: kmh / 1.60934
