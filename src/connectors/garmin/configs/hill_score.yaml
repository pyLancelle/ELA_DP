# =============================================================================
# GARMIN HILL SCORE - DAILY SCORES FORMAT
# =============================================================================
# This dataset contains Garmin's Hill Score metrics which measure performance
# on uphill terrain. Each record contains a weekly summary and daily scores.
#
# Structure:
# - Root level: user profile, date range, period average, max score
# - hillScoreDTOList: REPEATED RECORD with daily hill score breakdowns
#
# Each daily score includes:
# - strengthScore: Muscular strength component (0-100)
# - enduranceScore: Cardiovascular endurance component (0-100)
# - overallScore: Combined hill score (0-100)
# - hillScoreClassificationId: Performance classification
# =============================================================================

data_type: hill_score
description: "Garmin Hill Score - measures uphill running/cycling performance"
version: "2.0.0"
owner: "data-platform"
last_updated: "2025-11-02"

# =============================================================================
# SOURCE CONFIGURATION
# =============================================================================
source:
  bucket_pattern: "ela-dp-{env}"
  landing_path: "garmin/landing"
  file_pattern: "*_hill_score.jsonl"
  archive_path: "garmin/archive"
  rejected_path: "garmin/rejected"
  delete_after_archive: false
  max_file_age_days: 30

# =============================================================================
# DESTINATION CONFIGURATION
# =============================================================================
destination:
  project_id: "${GCP_PROJECT_ID}"
  dataset_pattern: "dp_lake_{env}"
  table_name: "lake_garmin__normalized_hill_score"
  write_disposition: "WRITE_APPEND"
  create_disposition: "CREATE_IF_NEEDED"

  partition:
    enabled: true
    field: "dp_inserted_at"
    type: "DAY"
    expiration_days: null

  clustering:
    enabled: true
    fields:
      - "userProfilePK"
      - "startDate"

# =============================================================================
# PARSING CONFIGURATION
# =============================================================================
parsing:
  strategy: "hybrid"

  core_fields:
    # Root-level fields
    - name: userProfilePK
      json_path: "$.userProfilePK"
      bq_type: INT64
      mode: NULLABLE
      description: "User profile primary key"

    - name: startDate
      json_path: "$.startDate"
      bq_type: DATE
      mode: NULLABLE
      description: "Period start date"
      transform: "string_to_date"

    - name: endDate
      json_path: "$.endDate"
      bq_type: DATE
      mode: NULLABLE
      description: "Period end date"
      transform: "string_to_date"

    - name: maxScore
      json_path: "$.maxScore"
      bq_type: INT64
      mode: NULLABLE
      description: "Maximum hill score in the period"

    # Period average scores (JSON object with dates as keys)
    - name: periodAvgScore
      json_path: "$.periodAvgScore"
      bq_type: JSON
      mode: NULLABLE
      description: "Period average scores by date (JSON object)"

    # =========================================================================
    # DAILY HILL SCORES (REPEATED RECORD)
    # =========================================================================
    - name: dailyScores
      bq_type: RECORD
      mode: REPEATED
      json_path: "$.hillScoreDTOList"
      description: "Daily hill score breakdowns"
      fields:
        - name: userProfilePK
          json_path: "$.userProfilePK"
          bq_type: INT64
          mode: NULLABLE
          description: "User profile primary key"

        - name: deviceId
          json_path: "$.deviceId"
          bq_type: INT64
          mode: NULLABLE
          description: "Device ID used for measurement"

        - name: calendarDate
          json_path: "$.calendarDate"
          bq_type: DATE
          mode: NULLABLE
          description: "Date of the score"
          transform: "string_to_date"

        - name: strengthScore
          json_path: "$.strengthScore"
          bq_type: INT64
          mode: NULLABLE
          description: "Muscular strength score (0-100)"

        - name: enduranceScore
          json_path: "$.enduranceScore"
          bq_type: INT64
          mode: NULLABLE
          description: "Cardiovascular endurance score (0-100)"

        - name: overallScore
          json_path: "$.overallScore"
          bq_type: INT64
          mode: NULLABLE
          description: "Combined hill score (0-100)"

        - name: hillScoreClassificationId
          json_path: "$.hillScoreClassificationId"
          bq_type: INT64
          mode: NULLABLE
          description: "Classification ID for performance level"

        - name: hillScoreFeedbackPhraseId
          json_path: "$.hillScoreFeedbackPhraseId"
          bq_type: INT64
          mode: NULLABLE
          description: "Feedback phrase ID"

        - name: vo2Max
          json_path: "$.vo2Max"
          bq_type: INT64
          mode: NULLABLE
          description: "VO2 Max value (if available)"

        - name: vo2MaxPreciseValue
          json_path: "$.vo2MaxPreciseValue"
          bq_type: FLOAT64
          mode: NULLABLE
          description: "Precise VO2 Max value"

        - name: primaryTrainingDevice
          json_path: "$.primaryTrainingDevice"
          bq_type: BOOL
          mode: NULLABLE
          description: "Whether this is the primary training device"

metadata_fields:
  - name: raw_data
    bq_type: JSON
    mode: NULLABLE
    description: "Original record data"

  - name: dp_inserted_at
    bq_type: TIMESTAMP
    mode: REQUIRED
    description: "Ingestion timestamp"
    default: "CURRENT_TIMESTAMP"

  - name: source_file
    bq_type: STRING
    mode: NULLABLE
    description: "Source file for audit"

quality_checks:
  unique_key: startDate
  deduplication_strategy: "keep_latest"
  required_fields:
    - startDate
  validation_mode: "warn"
  null_handling:
    strategy: "allow"
    replacement_values: {}

transformations:
  string_to_date:
    description: "Convert ISO date string to DATE"
    logic: "datetime.fromisoformat(value).date()"

performance:
  batch_size: 500
  max_workers: 4

logging:
  level: INFO
  console: true

notes: |
  GARMIN HILL SCORE

  This dataset tracks performance on uphill terrain over time.

  Structure:
  - 1 record per week (startDate â†’ endDate period)
  - dailyScores: REPEATED RECORD with up to 8 daily breakdowns

  Key metrics:
  - strengthScore: Muscular power for climbing (0-100)
  - enduranceScore: Cardiovascular capacity for sustained climbs (0-100)
  - overallScore: Combined metric (0-100)
  - maxScore: Best score in the period

  Classifications (hillScoreClassificationId):
  - 1: Beginner
  - 2: Intermediate
  - 3: Advanced
  - 4: Elite

  Query example - Get best daily scores:
  SELECT
    startDate,
    endDate,
    maxScore,
    daily.calendarDate,
    daily.overallScore,
    daily.strengthScore,
    daily.enduranceScore
  FROM table, UNNEST(dailyScores) AS daily
  WHERE daily.overallScore >= 35
  ORDER BY daily.calendarDate DESC

# =============================================================================
# ALERTING
# =============================================================================
alerting:
  enabled: false
  conditions:
    - name: high_rejection_rate
      threshold: 0.1
    - name: no_data
      threshold: 0
    - name: processing_time
      threshold: 600
  channels:
    - email
    - slack

# =============================================================================
# EXAMPLES
# =============================================================================
examples:
  - name: "Ingest hill_score to dev"
    command: "python -m src.connectors.garmin.garmin_ingest_v2 --config hill_score --env dev"

  - name: "Ingest hill_score to prod"
    command: "python -m src.connectors.garmin.garmin_ingest_v2 --config hill_score --env prd"

  - name: "Dry run"
    command: "python -m src.connectors.garmin.garmin_ingest_v2 --config hill_score --env dev --dry-run"
