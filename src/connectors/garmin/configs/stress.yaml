# =============================================================================
# GARMIN STRESS - COMPLETE INGESTION CONFIGURATION
# =============================================================================
# This configuration handles Garmin stress level data with time-series arrays.
#
# Structure:
# - Top-level: userProfilePK, calendarDate, timestamps
# - Daily aggregates: maxStressLevel, avgStressLevel
# - Chart metadata: offset, Y-axis origin
# - stressValuesArray: Time-series data (timestamp, stressLevel)
# - Optional: bodyBatteryValuesArray (in some records)
# =============================================================================

data_type: stress
description: "Garmin stress level data with time-series measurements"
version: "1.0.0"
owner: "data-platform"
last_updated: "2025-10-31"

# =============================================================================
# SOURCE CONFIGURATION
# =============================================================================
source:
  bucket_pattern: "ela-dp-{env}"
  landing_path: "garmin/landing"
  file_pattern: "*_stress.jsonl"
  archive_path: "garmin/archive"
  rejected_path: "garmin/rejected"
  delete_after_archive: false
  max_file_age_days: 30

# =============================================================================
# DESTINATION CONFIGURATION
# =============================================================================
destination:
  project_id: "${GCP_PROJECT_ID}"
  dataset_pattern: "dp_lake_{env}"
  table_name: "lake_garmin__normalized_stress"
  write_disposition: "WRITE_APPEND"
  create_disposition: "CREATE_IF_NEEDED"

  partition:
    enabled: true
    field: "dp_inserted_at"
    type: "DAY"
    expiration_days: null

  clustering:
    enabled: true
    fields:
      - "userProfilePK"
      - "calendarDate"

# =============================================================================
# PARSING CONFIGURATION
# =============================================================================
parsing:
  strategy: "hybrid"

  core_fields:
    # =========================================================================
    # IDENTIFIERS
    # =========================================================================
    - name: userProfilePK
      json_path: "$.userProfilePK"
      bq_type: INT64
      mode: REQUIRED
      description: "Garmin user profile primary key"
      validations:
        - type: not_null
        - type: positive

    - name: calendarDate
      json_path: "$.calendarDate"
      bq_type: DATE
      mode: REQUIRED
      description: "Date of stress data (used for partitioning)"
      transform: "string_to_date"
      validations:
        - type: not_null

    # =========================================================================
    # TIMESTAMPS
    # =========================================================================
    - name: startTimestampGMT
      json_path: "$.startTimestampGMT"
      bq_type: TIMESTAMP
      mode: NULLABLE
      description: "Start timestamp GMT"
      transform: "string_to_timestamp"

    - name: endTimestampGMT
      json_path: "$.endTimestampGMT"
      bq_type: TIMESTAMP
      mode: NULLABLE
      description: "End timestamp GMT"
      transform: "string_to_timestamp"

    - name: startTimestampLocal
      json_path: "$.startTimestampLocal"
      bq_type: TIMESTAMP
      mode: NULLABLE
      description: "Start timestamp local"
      transform: "string_to_timestamp"

    - name: endTimestampLocal
      json_path: "$.endTimestampLocal"
      bq_type: TIMESTAMP
      mode: NULLABLE
      description: "End timestamp local"
      transform: "string_to_timestamp"

    # =========================================================================
    # DAILY AGGREGATES
    # =========================================================================
    - name: maxStressLevel
      json_path: "$.maxStressLevel"
      bq_type: INT64
      mode: NULLABLE
      description: "Maximum stress level during the day (0-100)"
      validations:
        - type: range
          min: -1
          max: 100

    - name: avgStressLevel
      json_path: "$.avgStressLevel"
      bq_type: INT64
      mode: NULLABLE
      description: "Average stress level during the day (0-100)"
      validations:
        - type: range
          min: -1
          max: 100

    # =========================================================================
    # CHART METADATA
    # =========================================================================
    - name: stressChartValueOffset
      json_path: "$.stressChartValueOffset"
      bq_type: INT64
      mode: NULLABLE
      description: "Chart value offset for visualization"

    - name: stressChartYAxisOrigin
      json_path: "$.stressChartYAxisOrigin"
      bq_type: INT64
      mode: NULLABLE
      description: "Chart Y-axis origin for visualization"

    # =========================================================================
    # STRESS VALUES (REPEATED RECORD with array_index)
    # =========================================================================
    - name: stressValues
      bq_type: RECORD
      mode: REPEATED
      json_path: "$.stressValuesArray"
      description: "Stress level time-series measurements"
      fields:
        - name: timestamp
          array_index: 0
          bq_type: TIMESTAMP
          mode: NULLABLE
          description: "Measurement timestamp (epoch milliseconds)"
          transform: "timestamp_ms_to_timestamp"

        - name: stressLevel
          array_index: 1
          bq_type: INT64
          mode: NULLABLE
          description: "Stress level (0-100, -1 = rest/sleep, -2 = too stressed to measure)"
          validations:
            - type: range
              min: -2
              max: 100

    # =========================================================================
    # BODY BATTERY VALUES (OPTIONAL - present in some records)
    # =========================================================================
    - name: bodyBatteryValues
      bq_type: RECORD
      mode: REPEATED
      json_path: "$.bodyBatteryValuesArray"
      description: "Body Battery time-series measurements (optional, when available)"
      fields:
        - name: timestamp
          array_index: 0
          bq_type: TIMESTAMP
          mode: NULLABLE
          description: "Measurement timestamp (epoch milliseconds)"
          transform: "timestamp_ms_to_timestamp"

        - name: bodyBatteryLevel
          array_index: 1
          bq_type: INT64
          mode: NULLABLE
          description: "Body Battery level (0-100)"
          validations:
            - type: range
              min: 0
              max: 100

  # ===========================================================================
  # EXTENDED FIELDS
  # ===========================================================================
  extended_fields_reference:
    note: "All 23 paths are included as core fields - no extended fields needed"
    descriptor_fields: "stressValueDescriptorsDTOList and bodyBatteryValueDescriptorsDTOList are metadata, stored in raw_data"

# =============================================================================
# METADATA FIELDS
# =============================================================================
metadata_fields:
  - name: raw_data
    bq_type: JSON
    mode: NULLABLE
    description: "Complete stress JSON including descriptors"

  - name: dp_inserted_at
    bq_type: TIMESTAMP
    mode: REQUIRED
    description: "Timestamp when record was ingested"
    default: "CURRENT_TIMESTAMP"

  - name: source_file
    bq_type: STRING
    mode: NULLABLE
    description: "Source JSONL filename"

# =============================================================================
# QUALITY CHECKS
# =============================================================================
quality_checks:
  unique_key: userProfilePK
  deduplication_strategy: "keep_latest"

  required_fields:
    - userProfilePK
    - calendarDate

  validation_mode: "warn"

  null_handling:
    strategy: "allow"
    replacement_values: {}

# =============================================================================
# TRANSFORMATIONS
# =============================================================================
transformations:
  string_to_timestamp:
    description: "Convert ISO string to TIMESTAMP"
    logic: "datetime.fromisoformat(value.replace('.0', ''))"

  string_to_date:
    description: "Convert YYYY-MM-DD string to DATE"
    logic: "datetime.strptime(value, '%Y-%m-%d').date()"

  timestamp_ms_to_timestamp:
    description: "Convert milliseconds epoch to TIMESTAMP"
    logic: "datetime.fromtimestamp(value / 1000)"

# =============================================================================
# PERFORMANCE CONFIGURATION
# =============================================================================
performance:
  batch_size: 500
  max_batch_size_mb: 10
  max_workers: 4
  parallel_file_limit: 10
  max_memory_mb: 2048
  stream_large_files: true
  bq_job_timeout_seconds: 600
  gcs_download_timeout: 300

  retry:
    enabled: true
    max_attempts: 3
    backoff_seconds: 5
    backoff_multiplier: 2

# =============================================================================
# LOGGING
# =============================================================================
logging:
  level: INFO
  console: true
  file: false
  include_sample_records: true
  max_sample_records: 3
  log_rejected_records: true
  log_validation_failures: true
  track_metrics: true

# =============================================================================
# ALERTING
# =============================================================================
alerting:
  enabled: false

  conditions:
    - name: high_rejection_rate
      threshold: 0.1

    - name: no_data
      threshold: 0

    - name: processing_time
      threshold: 600

  channels:
    - email
    - slack

# =============================================================================
# EXAMPLES
# =============================================================================
examples:
  - name: "Ingest stress to dev"
    command: "python -m src.connectors.garmin.garmin_ingest_v2 --config stress --env dev"

  - name: "Ingest stress to prod"
    command: "python -m src.connectors.garmin.garmin_ingest_v2 --config stress --env prd"

  - name: "Dry run"
    command: "python -m src.connectors.garmin.garmin_ingest_v2 --config stress --env dev --dry-run"

  - name: "Verbose logging"
    command: "python -m src.connectors.garmin.garmin_ingest_v2 --config stress --env dev --log-level DEBUG"

# =============================================================================
# NOTES
# =============================================================================
notes: |
  GARMIN STRESS LEVEL DATA:

  Stress is measured continuously throughout the day using heart rate variability.

  Stress levels:
  - 0-25: Low stress / Rest
  - 26-50: Medium stress
  - 51-75: High stress
  - 76-100: Very high stress
  - -1: Rest period (no stress measurement)
  - -2: Too stressed to measure accurately

  Data includes:
  1. Daily aggregates (max/avg stress)
  2. Time-series measurements (every 3 minutes typically)
  3. Chart metadata for visualization
  4. Optional Body Battery values (in some records)

  Query examples:

  # Daily stress summary
  SELECT
    calendarDate,
    userProfilePK,
    avgStressLevel,
    maxStressLevel,
    COUNT(*) as measurement_count
  FROM `lake_garmin__stress_normalized`,
  UNNEST(stressValues) AS stress
  WHERE calendarDate >= '2025-10-01'
  GROUP BY 1, 2, 3, 4
  ORDER BY calendarDate DESC;

  # Stress level distribution
  SELECT
    calendarDate,
    stress.timestamp,
    stress.stressLevel,
    CASE
      WHEN stress.stressLevel = -1 THEN 'REST'
      WHEN stress.stressLevel = -2 THEN 'TOO_STRESSED'
      WHEN stress.stressLevel BETWEEN 0 AND 25 THEN 'LOW'
      WHEN stress.stressLevel BETWEEN 26 AND 50 THEN 'MEDIUM'
      WHEN stress.stressLevel BETWEEN 51 AND 75 THEN 'HIGH'
      WHEN stress.stressLevel BETWEEN 76 AND 100 THEN 'VERY_HIGH'
    END AS stress_category
  FROM `lake_garmin__stress_normalized`,
  UNNEST(stressValues) AS stress
  WHERE calendarDate = '2025-10-29'
  ORDER BY stress.timestamp;

  # Correlation with Body Battery
  SELECT
    calendarDate,
    AVG(stress.stressLevel) as avg_stress,
    AVG(bb.bodyBatteryLevel) as avg_body_battery
  FROM `lake_garmin__stress_normalized`,
  UNNEST(stressValues) AS stress
  LEFT JOIN UNNEST(bodyBatteryValues) AS bb
    ON stress.timestamp = bb.timestamp
  WHERE calendarDate >= '2025-09-01'
  GROUP BY calendarDate
  ORDER BY calendarDate;
