# =============================================================================
# GARMIN HRV - COMPLETE INGESTION CONFIGURATION
# =============================================================================
# This configuration handles Garmin Heart Rate Variability (HRV) data.
#
# Structure:
# - Top-level: userProfilePk, date, timestamps
# - hrvSummary: RECORD with aggregates, baseline (nested RECORD), status
# - hrvReadings: REPEATED RECORD with time-series measurements during sleep
#
# HRV is a key indicator of recovery and overall health status.
# =============================================================================

data_type: hrv
description: "Garmin HRV data with summary, baseline, and sleep measurements"
version: "1.0.0"
owner: "data-platform"
last_updated: "2025-10-31"

# =============================================================================
# SOURCE CONFIGURATION
# =============================================================================
source:
  bucket_pattern: "ela-dp-{env}"
  landing_path: "garmin/landing"
  file_pattern: "*_hrv.jsonl"
  archive_path: "garmin/archive"
  rejected_path: "garmin/rejected"
  delete_after_archive: false
  max_file_age_days: 30

# =============================================================================
# DESTINATION CONFIGURATION
# =============================================================================
destination:
  project_id: "${GCP_PROJECT_ID}"
  dataset_pattern: "dp_lake_{env}"
  table_name: "lake_garmin__normalized_hrv"
  write_disposition: "WRITE_APPEND"
  create_disposition: "CREATE_IF_NEEDED"

  partition:
    enabled: true
    field: "dp_inserted_at"
    type: "DAY"
    expiration_days: null

  clustering:
    enabled: true
    fields:
      - "userProfilePk"
      - "date"

# =============================================================================
# PARSING CONFIGURATION
# =============================================================================
parsing:
  strategy: "hybrid"

  core_fields:
    # =========================================================================
    # IDENTIFIERS
    # =========================================================================
    - name: userProfilePk
      json_path: "$.userProfilePk"
      bq_type: INT64
      mode: REQUIRED
      description: "Garmin user profile primary key"
      validations:
        - type: not_null
        - type: positive

    - name: date
      json_path: "$.date"
      bq_type: DATE
      mode: REQUIRED
      description: "Date of HRV data (used for partitioning)"
      transform: "string_to_date"
      validations:
        - type: not_null

    # =========================================================================
    # TIMESTAMPS
    # =========================================================================
    - name: startTimestampGMT
      json_path: "$.startTimestampGMT"
      bq_type: TIMESTAMP
      mode: NULLABLE
      description: "Recording start timestamp GMT"
      transform: "string_to_timestamp"

    - name: endTimestampGMT
      json_path: "$.endTimestampGMT"
      bq_type: TIMESTAMP
      mode: NULLABLE
      description: "Recording end timestamp GMT"
      transform: "string_to_timestamp"

    - name: startTimestampLocal
      json_path: "$.startTimestampLocal"
      bq_type: TIMESTAMP
      mode: NULLABLE
      description: "Recording start timestamp local"
      transform: "string_to_timestamp"

    - name: endTimestampLocal
      json_path: "$.endTimestampLocal"
      bq_type: TIMESTAMP
      mode: NULLABLE
      description: "Recording end timestamp local"
      transform: "string_to_timestamp"

    # =========================================================================
    # SLEEP TIMESTAMPS
    # =========================================================================
    - name: sleepStartTimestampGMT
      json_path: "$.sleepStartTimestampGMT"
      bq_type: TIMESTAMP
      mode: NULLABLE
      description: "Sleep start timestamp GMT"
      transform: "string_to_timestamp"

    - name: sleepEndTimestampGMT
      json_path: "$.sleepEndTimestampGMT"
      bq_type: TIMESTAMP
      mode: NULLABLE
      description: "Sleep end timestamp GMT"
      transform: "string_to_timestamp"

    - name: sleepStartTimestampLocal
      json_path: "$.sleepStartTimestampLocal"
      bq_type: TIMESTAMP
      mode: NULLABLE
      description: "Sleep start timestamp local"
      transform: "string_to_timestamp"

    - name: sleepEndTimestampLocal
      json_path: "$.sleepEndTimestampLocal"
      bq_type: TIMESTAMP
      mode: NULLABLE
      description: "Sleep end timestamp local"
      transform: "string_to_timestamp"

    # =========================================================================
    # HRV SUMMARY (RECORD with nested baseline RECORD)
    # =========================================================================
    - name: hrvSummary
      bq_type: RECORD
      mode: NULLABLE
      json_path: "$.hrvSummary"
      description: "HRV summary with aggregates, baseline, and status"
      fields:
        - name: calendarDate
          json_path: "$.calendarDate"
          bq_type: DATE
          mode: NULLABLE
          description: "Calendar date for this summary"
          transform: "string_to_date"

        - name: weeklyAvg
          json_path: "$.weeklyAvg"
          bq_type: INT64
          mode: NULLABLE
          description: "Weekly average HRV in milliseconds"

        - name: lastNightAvg
          json_path: "$.lastNightAvg"
          bq_type: INT64
          mode: NULLABLE
          description: "Last night average HRV in milliseconds"

        - name: lastNight5MinHigh
          json_path: "$.lastNight5MinHigh"
          bq_type: INT64
          mode: NULLABLE
          description: "Highest 5-minute average HRV from last night"

        - name: baseline
          bq_type: RECORD
          mode: NULLABLE
          json_path: "$.baseline"
          description: "HRV baseline ranges for status classification"
          fields:
            - name: lowUpper
              json_path: "$.lowUpper"
              bq_type: INT64
              mode: NULLABLE
              description: "Upper bound of low HRV range"

            - name: balancedLow
              json_path: "$.balancedLow"
              bq_type: INT64
              mode: NULLABLE
              description: "Lower bound of balanced HRV range"

            - name: balancedUpper
              json_path: "$.balancedUpper"
              bq_type: INT64
              mode: NULLABLE
              description: "Upper bound of balanced HRV range"

            - name: markerValue
              json_path: "$.markerValue"
              bq_type: FLOAT64
              mode: NULLABLE
              description: "Marker value for HRV status"

        - name: status
          json_path: "$.status"
          bq_type: STRING
          mode: NULLABLE
          description: "HRV status: LOW, BALANCED, UNBALANCED"

        - name: feedbackPhrase
          json_path: "$.feedbackPhrase"
          bq_type: STRING
          mode: NULLABLE
          description: "Feedback phrase key for user messaging"

        - name: createTimeStamp
          json_path: "$.createTimeStamp"
          bq_type: TIMESTAMP
          mode: NULLABLE
          description: "Timestamp when summary was created"
          transform: "string_to_timestamp_iso"

    # =========================================================================
    # HRV READINGS (REPEATED RECORD)
    # =========================================================================
    - name: hrvReadings
      bq_type: RECORD
      mode: REPEATED
      json_path: "$.hrvReadings"
      description: "HRV measurements during sleep (every 5 minutes)"
      fields:
        - name: hrvValue
          json_path: "$.hrvValue"
          bq_type: INT64
          mode: NULLABLE
          description: "HRV value in milliseconds"
          validations:
            - type: range
              min: 0
              max: 200

        - name: readingTimeGMT
          json_path: "$.readingTimeGMT"
          bq_type: TIMESTAMP
          mode: NULLABLE
          description: "Reading timestamp GMT"
          transform: "string_to_timestamp"

        - name: readingTimeLocal
          json_path: "$.readingTimeLocal"
          bq_type: TIMESTAMP
          mode: NULLABLE
          description: "Reading timestamp local"
          transform: "string_to_timestamp"

  # ===========================================================================
  # EXTENDED FIELDS
  # ===========================================================================
  extended_fields_reference:
    note: "All 28 paths are included as core fields - no extended fields needed"

# =============================================================================
# METADATA FIELDS
# =============================================================================
metadata_fields:
  - name: raw_data
    bq_type: JSON
    mode: NULLABLE
    description: "Complete HRV JSON for reference"

  - name: dp_inserted_at
    bq_type: TIMESTAMP
    mode: REQUIRED
    description: "Timestamp when record was ingested"
    default: "CURRENT_TIMESTAMP"

  - name: source_file
    bq_type: STRING
    mode: NULLABLE
    description: "Source JSONL filename"

# =============================================================================
# QUALITY CHECKS
# =============================================================================
quality_checks:
  unique_key: userProfilePk
  deduplication_strategy: "keep_latest"

  required_fields:
    - userProfilePk
    - date

  validation_mode: "warn"

  null_handling:
    strategy: "allow"
    replacement_values: {}

# =============================================================================
# TRANSFORMATIONS
# =============================================================================
transformations:
  string_to_timestamp:
    description: "Convert ISO string to TIMESTAMP"
    logic: "datetime.fromisoformat(value.replace('.0', ''))"

  string_to_timestamp_iso:
    description: "Convert ISO 8601 string to TIMESTAMP (with milliseconds)"
    logic: "datetime.fromisoformat(value)"

  string_to_date:
    description: "Convert YYYY-MM-DD string to DATE"
    logic: "datetime.strptime(value, '%Y-%m-%d').date()"

# =============================================================================
# PERFORMANCE CONFIGURATION
# =============================================================================
performance:
  batch_size: 500
  max_batch_size_mb: 10
  max_workers: 4
  parallel_file_limit: 10
  max_memory_mb: 2048
  stream_large_files: true
  bq_job_timeout_seconds: 600
  gcs_download_timeout: 300

  retry:
    enabled: true
    max_attempts: 3
    backoff_seconds: 5
    backoff_multiplier: 2

# =============================================================================
# LOGGING
# =============================================================================
logging:
  level: INFO
  console: true
  file: false
  include_sample_records: true
  max_sample_records: 3
  log_rejected_records: true
  log_validation_failures: true
  track_metrics: true

# =============================================================================
# ALERTING
# =============================================================================
alerting:
  enabled: false

  conditions:
    - name: high_rejection_rate
      threshold: 0.1

    - name: no_data
      threshold: 0

    - name: processing_time
      threshold: 600

  channels:
    - email
    - slack

# =============================================================================
# EXAMPLES
# =============================================================================
examples:
  - name: "Ingest hrv to dev"
    command: "python -m src.connectors.garmin.garmin_ingest_v2 --config hrv --env dev"

  - name: "Ingest hrv to prod"
    command: "python -m src.connectors.garmin.garmin_ingest_v2 --config hrv --env prd"

  - name: "Dry run"
    command: "python -m src.connectors.garmin.garmin_ingest_v2 --config hrv --env dev --dry-run"

  - name: "Verbose logging"
    command: "python -m src.connectors.garmin.garmin_ingest_v2 --config hrv --env dev --log-level DEBUG"

# =============================================================================
# NOTES
# =============================================================================
notes: |
  GARMIN HRV (HEART RATE VARIABILITY) DATA:

  HRV is a key indicator of recovery, stress, and overall health. Higher HRV
  generally indicates better recovery and adaptability.

  Status categories:
  - LOW: HRV below baseline (may indicate stress, fatigue, or illness)
  - BALANCED: HRV within normal range
  - UNBALANCED: HRV significantly different from baseline

  Baseline ranges:
  - lowUpper: Maximum HRV for "low" status
  - balancedLow - balancedUpper: Normal range for user
  - Above balancedUpper: May indicate excellent recovery

  Data structure:
  1. Daily summary (hrvSummary) with weekly avg, last night avg, baseline
  2. Individual readings (hrvReadings) taken every 5 minutes during sleep
  3. Sleep period timestamps
  4. Status and feedback for user insights

  Query examples:

  # Daily HRV trend
  SELECT
    date,
    userProfilePk,
    hrvSummary.lastNightAvg AS last_night_hrv,
    hrvSummary.weeklyAvg AS weekly_avg_hrv,
    hrvSummary.status,
    hrvSummary.baseline.balancedLow AS baseline_low,
    hrvSummary.baseline.balancedUpper AS baseline_high
  FROM `lake_garmin__hrv_normalized`
  WHERE date >= '2025-10-01'
  ORDER BY date DESC;

  # HRV readings analysis
  SELECT
    date,
    reading.readingTimeGMT,
    reading.hrvValue,
    AVG(reading.hrvValue) OVER (
      PARTITION BY date
      ORDER BY reading.readingTimeGMT
      ROWS BETWEEN 2 PRECEDING AND 2 FOLLOWING
    ) AS rolling_avg_5_readings
  FROM `lake_garmin__hrv_normalized`,
  UNNEST(hrvReadings) AS reading
  WHERE date = '2025-10-29'
  ORDER BY reading.readingTimeGMT;

  # HRV status distribution
  SELECT
    hrvSummary.status,
    COUNT(*) AS days_count,
    AVG(hrvSummary.lastNightAvg) AS avg_hrv
  FROM `lake_garmin__hrv_normalized`
  WHERE date >= '2025-09-01'
  GROUP BY hrvSummary.status
  ORDER BY days_count DESC;

  # Recovery analysis (HRV vs baseline)
  SELECT
    date,
    hrvSummary.lastNightAvg,
    hrvSummary.baseline.balancedLow,
    hrvSummary.lastNightAvg - hrvSummary.baseline.balancedLow AS recovery_score,
    CASE
      WHEN hrvSummary.lastNightAvg < hrvSummary.baseline.lowUpper THEN 'POOR_RECOVERY'
      WHEN hrvSummary.lastNightAvg BETWEEN hrvSummary.baseline.balancedLow AND hrvSummary.baseline.balancedUpper THEN 'GOOD_RECOVERY'
      WHEN hrvSummary.lastNightAvg > hrvSummary.baseline.balancedUpper THEN 'EXCELLENT_RECOVERY'
    END AS recovery_status
  FROM `lake_garmin__hrv_normalized`
  WHERE date >= '2025-10-01'
  ORDER BY date DESC;
