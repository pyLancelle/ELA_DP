data_type: training_status
description: "Garmin training status, load balance, and VO2max with comprehensive RECORD support"
version: "3.0.0"
owner: "data-platform"
last_updated: "2025-10-30"

source:
  bucket_pattern: "ela-dp-{env}"
  landing_path: "garmin/landing"
  file_pattern: "*_training_status.jsonl"
  archive_path: "garmin/archive"
  rejected_path: "garmin/rejected"
  delete_after_archive: false
  max_file_age_days: 30

destination:
  project_id: "${GCP_PROJECT_ID}"
  dataset_pattern: "dp_lake_{env}"
  table_name: "lake_garmin__normalized_training_status"
  write_disposition: "WRITE_APPEND"
  create_disposition: "CREATE_IF_NEEDED"

  partition:
    enabled: true
    field: "dp_inserted_at"
    type: "DAY"
    expiration_days: null

  clustering:
    enabled: true
    fields:
      - "userId"
      - "date"

parsing:
  strategy: "hybrid"

  core_fields:
    # =========================================================================
    # IDENTIFIERS
    # =========================================================================
    - name: userId
      json_path: "$.userId"
      bq_type: INT64
      mode: REQUIRED
      description: "User identifier"
      validations:
        - type: not_null

    - name: date
      json_path: "$.date"
      bq_type: DATE
      mode: REQUIRED
      description: "Date for this training status snapshot"
      transform: "string_to_date"
      validations:
        - type: not_null

    # =========================================================================
    # VO2 MAX (RECORD)
    # =========================================================================
    - name: vo2Max
      bq_type: RECORD
      mode: NULLABLE
      json_path: "$.mostRecentVO2Max.generic"
      description: "VO2 max measurement data"
      fields:
        - name: vo2MaxValue
          json_path: "$.vo2MaxValue"
          bq_type: FLOAT64
          mode: NULLABLE
          description: "VO2 max value (ml/kg/min)"

        - name: vo2MaxPreciseValue
          json_path: "$.vo2MaxPreciseValue"
          bq_type: FLOAT64
          mode: NULLABLE
          description: "Precise VO2 max value"

        - name: calendarDate
          json_path: "$.calendarDate"
          bq_type: DATE
          mode: NULLABLE
          description: "Date of VO2 max measurement"
          transform: "string_to_date"

        - name: fitnessAge
          json_path: "$.fitnessAge"
          bq_type: INT64
          mode: NULLABLE
          description: "Calculated fitness age"

        - name: fitnessAgeDescription
          json_path: "$.fitnessAgeDescription"
          bq_type: STRING
          mode: NULLABLE
          description: "Description of fitness age"

        - name: maxMetCategory
          json_path: "$.maxMetCategory"
          bq_type: INT64
          mode: NULLABLE
          description: "Maximum MET category"

    # =========================================================================
    # HEAT & ALTITUDE ACCLIMATION (RECORD)
    # =========================================================================
    - name: heatAltitudeAcclimation
      bq_type: RECORD
      mode: NULLABLE
      json_path: "$.mostRecentVO2Max.heatAltitudeAcclimation"
      description: "Heat and altitude acclimation data"
      fields:
        - name: calendarDate
          json_path: "$.calendarDate"
          bq_type: DATE
          mode: NULLABLE
          transform: "string_to_date"
          description: "Calendar date for acclimation"

        - name: altitudeAcclimationDate
          json_path: "$.altitudeAcclimationDate"
          bq_type: DATE
          mode: NULLABLE
          transform: "string_to_date"
          description: "Date of altitude acclimation"

        - name: previousAltitudeAcclimationDate
          json_path: "$.previousAltitudeAcclimationDate"
          bq_type: DATE
          mode: NULLABLE
          transform: "string_to_date"
          description: "Previous altitude acclimation date"

        - name: heatAcclimationDate
          json_path: "$.heatAcclimationDate"
          bq_type: DATE
          mode: NULLABLE
          transform: "string_to_date"
          description: "Date of heat acclimation"

        - name: previousHeatAcclimationDate
          json_path: "$.previousHeatAcclimationDate"
          bq_type: DATE
          mode: NULLABLE
          transform: "string_to_date"
          description: "Previous heat acclimation date"

        - name: altitudeAcclimation
          json_path: "$.altitudeAcclimation"
          bq_type: INT64
          mode: NULLABLE
          description: "Altitude acclimation value"

        - name: previousAltitudeAcclimation
          json_path: "$.previousAltitudeAcclimation"
          bq_type: INT64
          mode: NULLABLE
          description: "Previous altitude acclimation value"

        - name: heatAcclimationPercentage
          json_path: "$.heatAcclimationPercentage"
          bq_type: INT64
          mode: NULLABLE
          description: "Heat acclimation percentage"

        - name: previousHeatAcclimationPercentage
          json_path: "$.previousHeatAcclimationPercentage"
          bq_type: INT64
          mode: NULLABLE
          description: "Previous heat acclimation percentage"

        - name: heatTrend
          json_path: "$.heatTrend"
          bq_type: STRING
          mode: NULLABLE
          description: "Heat acclimation trend"

        - name: altitudeTrend
          json_path: "$.altitudeTrend"
          bq_type: STRING
          mode: NULLABLE
          description: "Altitude acclimation trend"

        - name: currentAltitude
          json_path: "$.currentAltitude"
          bq_type: INT64
          mode: NULLABLE
          description: "Current altitude (meters)"

        - name: previousAltitude
          json_path: "$.previousAltitude"
          bq_type: INT64
          mode: NULLABLE
          description: "Previous altitude (meters)"

        - name: acclimationPercentage
          json_path: "$.acclimationPercentage"
          bq_type: INT64
          mode: NULLABLE
          description: "Overall acclimation percentage"

        - name: previousAcclimationPercentage
          json_path: "$.previousAcclimationPercentage"
          bq_type: INT64
          mode: NULLABLE
          description: "Previous acclimation percentage"

        - name: altitudeAcclimationLocalTimestamp
          json_path: "$.altitudeAcclimationLocalTimestamp"
          bq_type: TIMESTAMP
          mode: NULLABLE
          transform: "string_to_timestamp"
          description: "Local timestamp of altitude acclimation"

    # =========================================================================
    # TRAINING STATUS (RECORD with wildcard for first device)
    # =========================================================================
    - name: trainingStatus
      bq_type: RECORD
      mode: NULLABLE
      json_path_base: "$.mostRecentTrainingStatus.latestTrainingStatusData.*"
      description: "Training status for primary device"
      fields:
        - name: calendarDate
          json_path: "$.calendarDate"
          bq_type: DATE
          mode: NULLABLE
          transform: "string_to_date"
          description: "Calendar date for training status"

        - name: sinceDate
          json_path: "$.sinceDate"
          bq_type: DATE
          mode: NULLABLE
          transform: "string_to_date"
          description: "Date since current status began"

        - name: deviceId
          json_path: "$.deviceId"
          bq_type: INT64
          mode: NULLABLE
          description: "Device identifier"

        - name: timestamp
          json_path: "$.timestamp"
          bq_type: TIMESTAMP
          mode: NULLABLE
          transform: "timestamp_ms_to_timestamp"
          description: "Timestamp of status"

        - name: trainingStatus
          json_path: "$.trainingStatus"
          bq_type: INT64
          mode: NULLABLE
          description: "Training status code"

        - name: trainingStatusFeedbackPhrase
          json_path: "$.trainingStatusFeedbackPhrase"
          bq_type: STRING
          mode: NULLABLE
          description: "Training status feedback"

        - name: fitnessTrend
          json_path: "$.fitnessTrend"
          bq_type: INT64
          mode: NULLABLE
          description: "Fitness trend indicator"

        - name: fitnessTrendSport
          json_path: "$.fitnessTrendSport"
          bq_type: STRING
          mode: NULLABLE
          description: "Sport for fitness trend"

        - name: sport
          json_path: "$.sport"
          bq_type: STRING
          mode: NULLABLE
          description: "Sport type"

        - name: subSport
          json_path: "$.subSport"
          bq_type: STRING
          mode: NULLABLE
          description: "Sub-sport type"

        - name: weeklyTrainingLoad
          json_path: "$.weeklyTrainingLoad"
          bq_type: INT64
          mode: NULLABLE
          description: "Weekly training load"

        - name: loadTunnelMin
          json_path: "$.loadTunnelMin"
          bq_type: INT64
          mode: NULLABLE
          description: "Minimum load tunnel value"

        - name: loadTunnelMax
          json_path: "$.loadTunnelMax"
          bq_type: INT64
          mode: NULLABLE
          description: "Maximum load tunnel value"

        - name: loadLevelTrend
          json_path: "$.loadLevelTrend"
          bq_type: STRING
          mode: NULLABLE
          description: "Load level trend"

        - name: trainingPaused
          json_path: "$.trainingPaused"
          bq_type: BOOL
          mode: NULLABLE
          description: "Whether training is paused"

        - name: primaryTrainingDevice
          json_path: "$.primaryTrainingDevice"
          bq_type: BOOL
          mode: NULLABLE
          description: "Whether this is the primary training device"

        # Acute Training Load nested fields
        - name: dailyTrainingLoadAcute
          json_path: "$.acuteTrainingLoadDTO.dailyTrainingLoadAcute"
          bq_type: INT64
          mode: NULLABLE
          description: "Daily acute training load"

        - name: dailyTrainingLoadChronic
          json_path: "$.acuteTrainingLoadDTO.dailyTrainingLoadChronic"
          bq_type: INT64
          mode: NULLABLE
          description: "Daily chronic training load"

        - name: dailyAcuteChronicWorkloadRatio
          json_path: "$.acuteTrainingLoadDTO.dailyAcuteChronicWorkloadRatio"
          bq_type: FLOAT64
          mode: NULLABLE
          description: "Acute to Chronic Workload Ratio"

        - name: acwrPercent
          json_path: "$.acuteTrainingLoadDTO.acwrPercent"
          bq_type: INT64
          mode: NULLABLE
          description: "ACWR percentage"

        - name: acwrStatus
          json_path: "$.acuteTrainingLoadDTO.acwrStatus"
          bq_type: STRING
          mode: NULLABLE
          description: "ACWR status (OPTIMAL, etc.)"

        - name: acwrStatusFeedback
          json_path: "$.acuteTrainingLoadDTO.acwrStatusFeedback"
          bq_type: STRING
          mode: NULLABLE
          description: "ACWR status feedback"

        - name: minTrainingLoadChronic
          json_path: "$.acuteTrainingLoadDTO.minTrainingLoadChronic"
          bq_type: FLOAT64
          mode: NULLABLE
          description: "Minimum chronic training load"

        - name: maxTrainingLoadChronic
          json_path: "$.acuteTrainingLoadDTO.maxTrainingLoadChronic"
          bq_type: FLOAT64
          mode: NULLABLE
          description: "Maximum chronic training load"

    # =========================================================================
    # LOAD BALANCE (RECORD with wildcard)
    # =========================================================================
    - name: loadBalance
      bq_type: RECORD
      mode: NULLABLE
      json_path_base: "$.mostRecentTrainingLoadBalance.metricsTrainingLoadBalanceDTOMap.*"
      description: "Training load balance for primary device"
      fields:
        - name: calendarDate
          json_path: "$.calendarDate"
          bq_type: DATE
          mode: NULLABLE
          transform: "string_to_date"
          description: "Calendar date for load balance"

        - name: deviceId
          json_path: "$.deviceId"
          bq_type: INT64
          mode: NULLABLE
          description: "Device identifier"

        - name: monthlyLoadAerobicLow
          json_path: "$.monthlyLoadAerobicLow"
          bq_type: FLOAT64
          mode: NULLABLE
          description: "Monthly aerobic low load"

        - name: monthlyLoadAerobicHigh
          json_path: "$.monthlyLoadAerobicHigh"
          bq_type: FLOAT64
          mode: NULLABLE
          description: "Monthly aerobic high load"

        - name: monthlyLoadAnaerobic
          json_path: "$.monthlyLoadAnaerobic"
          bq_type: FLOAT64
          mode: NULLABLE
          description: "Monthly anaerobic load"

        - name: monthlyLoadAerobicLowTargetMin
          json_path: "$.monthlyLoadAerobicLowTargetMin"
          bq_type: INT64
          mode: NULLABLE
          description: "Minimum target for aerobic low load"

        - name: monthlyLoadAerobicLowTargetMax
          json_path: "$.monthlyLoadAerobicLowTargetMax"
          bq_type: INT64
          mode: NULLABLE
          description: "Maximum target for aerobic low load"

        - name: monthlyLoadAerobicHighTargetMin
          json_path: "$.monthlyLoadAerobicHighTargetMin"
          bq_type: INT64
          mode: NULLABLE
          description: "Minimum target for aerobic high load"

        - name: monthlyLoadAerobicHighTargetMax
          json_path: "$.monthlyLoadAerobicHighTargetMax"
          bq_type: INT64
          mode: NULLABLE
          description: "Maximum target for aerobic high load"

        - name: monthlyLoadAnaerobicTargetMin
          json_path: "$.monthlyLoadAnaerobicTargetMin"
          bq_type: INT64
          mode: NULLABLE
          description: "Minimum target for anaerobic load"

        - name: monthlyLoadAnaerobicTargetMax
          json_path: "$.monthlyLoadAnaerobicTargetMax"
          bq_type: INT64
          mode: NULLABLE
          description: "Maximum target for anaerobic load"

        - name: trainingBalanceFeedbackPhrase
          json_path: "$.trainingBalanceFeedbackPhrase"
          bq_type: STRING
          mode: NULLABLE
          description: "Training balance feedback"

        - name: primaryTrainingDevice
          json_path: "$.primaryTrainingDevice"
          bq_type: BOOL
          mode: NULLABLE
          description: "Whether this is the primary training device"

    # =========================================================================
    # RECORDED DEVICES (REPEATED RECORD)
    # =========================================================================
    - name: recordedDevices
      bq_type: RECORD
      mode: REPEATED
      json_path: "$.mostRecentTrainingStatus.recordedDevices"
      description: "List of recorded devices for training status"
      fields:
        - name: deviceId
          json_path: "$.deviceId"
          bq_type: INT64
          mode: NULLABLE
          description: "Device identifier"

        - name: deviceName
          json_path: "$.deviceName"
          bq_type: STRING
          mode: NULLABLE
          description: "Device name"

        - name: imageURL
          json_path: "$.imageURL"
          bq_type: STRING
          mode: NULLABLE
          description: "Device image URL"

        - name: category
          json_path: "$.category"
          bq_type: INT64
          mode: NULLABLE
          description: "Device category"

    - name: recordedDevicesLoadBalance
      bq_type: RECORD
      mode: REPEATED
      json_path: "$.mostRecentTrainingLoadBalance.recordedDevices"
      description: "List of recorded devices for load balance"
      fields:
        - name: deviceId
          json_path: "$.deviceId"
          bq_type: INT64
          mode: NULLABLE
          description: "Device identifier"

        - name: deviceName
          json_path: "$.deviceName"
          bq_type: STRING
          mode: NULLABLE
          description: "Device name"

        - name: imageURL
          json_path: "$.imageURL"
          bq_type: STRING
          mode: NULLABLE
          description: "Device image URL"

        - name: category
          json_path: "$.category"
          bq_type: INT64
          mode: NULLABLE
          description: "Device category"

    # =========================================================================
    # TOP-LEVEL METADATA
    # =========================================================================
    - name: lastPrimarySyncDate
      json_path: "$.mostRecentTrainingStatus.lastPrimarySyncDate"
      bq_type: DATE
      mode: NULLABLE
      transform: "string_to_date"
      description: "Last primary sync date"

    - name: showSelector
      json_path: "$.mostRecentTrainingStatus.showSelector"
      bq_type: BOOL
      mode: NULLABLE
      description: "Whether to show device selector"

metadata_fields:
  - name: raw_data
    bq_type: JSON
    mode: NULLABLE
    description: "Complete training status data with all devices"

  - name: dp_inserted_at
    bq_type: TIMESTAMP
    mode: REQUIRED
    description: "Ingestion timestamp"

  - name: source_file
    bq_type: STRING
    mode: NULLABLE
    description: "Source file"

quality_checks:
  unique_key: userId
  deduplication_strategy: "keep_latest"
  required_fields:
    - userId
    - date
  validation_mode: "warn"
  null_handling:
    strategy: "allow"

transformations:
  string_to_date:
    description: "Convert string date to DATE"

  timestamp_ms_to_timestamp:
    description: "Convert Garmin timestamp (ms) to BigQuery TIMESTAMP"

  string_to_timestamp:
    description: "Convert ISO string timestamp to BigQuery TIMESTAMP"

performance:
  batch_size: 500
  max_workers: 4

logging:
  level: INFO
  console: true

notes: |
  RECORD/STRUCT FEATURES DEMONSTRATED:

  1. vo2_max: Simple RECORD with nested typed fields
  2. training_status: RECORD with wildcard ($.latestTrainingStatusData.*)
     - Takes first device found in map
  3. load_balance: RECORD with wildcard for device-specific data

  Benefits:
  - Typed nested fields â†’ fast queries without JSON_VALUE()
  - Supports multi-device data via wildcard
  - All fields queryable with dot notation (e.g., vo2_max.value)

  Query examples:
  SELECT
    user_id,
    vo2_max.value,
    training_status.status_code,
    training_status.acwr_ratio,
    load_balance.aerobic_high
  FROM table
  WHERE training_status.sport = 'RUNNING'

examples:
  - name: "Ingest training status to dev"
    command: "python -m src.connectors.garmin.garmin_ingest_v2 --config training_status --env dev"
