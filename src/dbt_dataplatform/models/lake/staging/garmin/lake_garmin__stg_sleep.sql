{{
  config(
      tags=['garmin', 'lake']
  )
}}

SELECT
    id,
    userprofilepk,
    calendardate,
    sleepstarttimestampgmt,
    sleependtimestampgmt,
    sleepstarttimestamplocal,
    sleependtimestamplocal,
    sleeptimeseconds,
    deepsleepseconds,
    lightsleepseconds,
    remsleepseconds,
    awakesleepseconds,
    naptimeseconds,
    avgheartrate,
    averagespo2value,
    lowestspo2value,
    highestspo2value,
    averagerespirationvalue,
    lowestrespirationvalue,
    highestrespirationvalue,
    sleepscores,
    awakecount,
    avgsleepstress,
    sleepwindowconfirmed,
    sleepwindowconfirmationtype,
    deviceremcapable,
    sleepfromdevice,
    autosleepstarttimestampgmt,
    autosleependtimestampgmt,
    unmeasurablesleepseconds,
    averagespo2hrsleep,
    sleepversion,
    sleepqualitytypepk,
    sleepresulttypepk,
    agegroup,
    breathingdisruptionseverity,
    retro,
    sleepscorefeedback,
    sleepscoreinsight,
    sleepscorepersonalizedinsight,
    avgovernighthrv,
    hrvstatus,
    bodybatterychange,
    restingheartrate,
    restlessmomentscount,
    remsleepdata,
    skintempdataexists,
    respirationversion,
    `date`,
    sleepmovement,
    sleepheartrate,
    sleepstress,
    sleepneed,
    nextsleepneed,
    wellnessspo2sleepsummarydto,
    sleepbodybattery,
    sleeplevels,
    hrvdata,
    wellnessepochspo2datadtolist,
    wellnessepochrespirationdatadtolist,
    wellnessepochrespirationaverageslist,
    breathingdisruptiondata,
    dailynapdtos,
    dp_inserted_at
FROM {{ source('garmin','sleep') }}
QUALIFY
    ROW_NUMBER() OVER (PARTITION BY calendardate ORDER BY dp_inserted_at DESC)
    = 1
