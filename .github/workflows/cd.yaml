name: CD - Build & Push Images

on:
  push:
    branches: [main]

env:
  PROJECT_ID: polar-scene-465223-f7
  REGION: europe-west1
  REPOSITORY: ela-dataplatform

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev
      
      - name: Extract version info
        id: version
        run: |
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "timestamp=$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
      
      - name: Build & Push Spotify Fetcher
        run: |
          IMAGE_BASE=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/spotify-fetcher
          
          docker build --platform linux/amd64 \
            -t $IMAGE_BASE:latest \
            -t $IMAGE_BASE:sha-${{ steps.version.outputs.sha_short }} \
            -t $IMAGE_BASE:${{ steps.version.outputs.timestamp }} \
            .
          
          docker push $IMAGE_BASE:latest
          docker push $IMAGE_BASE:sha-${{ steps.version.outputs.sha_short }}
          docker push $IMAGE_BASE:${{ steps.version.outputs.timestamp }}
      
      - name: ðŸ“¦ Build Summary
        run: |
          echo "=========================================="
          echo "âœ… Images built and pushed successfully!"
          echo "=========================================="
          echo ""
          echo "ðŸ“¦ Available images:"
          echo "- spotify-fetcher:latest"
          echo "- spotify-fetcher:sha-${{ steps.version.outputs.sha_short }}"
          echo "- spotify-fetcher:${{ steps.version.outputs.timestamp }}"
          echo ""
          echo "ðŸš€ Deploy manually using:"
          echo "   GitHub Actions â†’ Manual Deploy workflow"
          echo ""
          echo "ðŸ”— Artifact Registry:"
          echo "   https://console.cloud.google.com/artifacts/docker/${{ env.PROJECT_ID }}/${{ env.REGION }}/${{ env.REPOSITORY }}"
          echo "=========================================="