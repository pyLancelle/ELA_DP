name: "[DEV] Spotify Saved Tracks to GCS"

on:
  schedule:
    - cron: "0 12 * * 0"   # Weekly on Sundays at 12:00 UTC
  workflow_dispatch:

jobs:
  spotify-saved-tracks:
    runs-on: ubuntu-latest
    env:
      SPOTIFY_CLIENT_ID: ${{ secrets.SPOTIFY_CLIENT_ID }}
      SPOTIFY_CLIENT_SECRET: ${{ secrets.SPOTIFY_CLIENT_SECRET }}
      SPOTIFY_REDIRECT_URI: ${{ secrets.SPOTIFY_REDIRECT_URI }}
      SPOTIFY_REFRESH_TOKEN: ${{ secrets.SPOTIFY_REFRESH_TOKEN }}
      GCS_BUCKET: ela-dp-dev/spotify/landing

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python & cache pip
        uses: actions/setup-python@v5
        with:
          python-version: 3.12
      - uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml','**/poetry.lock') }}

      - name: Install dependencies
        run: pip install .

      - name: Run Spotify connector - Saved Tracks
        run: |
          # Fetch saved tracks (liked songs from library) - runs weekly
          python -m src.connectors.spotify.spotify_fetch saved_tracks --limit 500

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Set up Google Cloud SDK (gcloud + gsutil)
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          install_components: gsutil

      - name: Prepare files for upload
        id: prep
        run: |
          echo ">> Files generated:"
          ls -la *.jsonl || echo "No JSONL files found"
          
          # Find saved tracks Spotify files from this run
          SPOTIFY_FILES=$(find . -name "*spotify_saved_tracks*.jsonl" -type f)
          
          if [ -z "$SPOTIFY_FILES" ]; then
            echo "âŒ No Spotify saved tracks files found to upload"
            exit 1
          fi
          
          echo ">> Spotify saved tracks files to upload:"
          echo "$SPOTIFY_FILES"
          
          # Store files list for upload step
          echo "$SPOTIFY_FILES" > spotify_files_to_upload.txt

      - name: Upload to GCS
        run: |
          # Upload each Spotify file to GCS
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              echo "ðŸ“ Uploading: $file"
              gsutil cp "$file" "gs://$GCS_BUCKET/" \
                || { echo "âŒ Upload failed for $file" >&2; exit 1; }
              echo "âœ… Successfully uploaded: $file"
            fi
          done < spotify_files_to_upload.txt
          
          echo "ðŸŽ‰ Spotify saved tracks uploaded successfully"